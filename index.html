<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <title>CleanManager Pro</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <style>
    :root {
      --font: 'DM Sans', -apple-system, sans-serif;
      --bg: #0f0f14;
      --bg-sidebar: #16161e;
      --bg-card: #1c1c26;
      --bg-card-hover: #24242f;
      --bg-input: #13131a;
      --border: #2a2a3a;
      --border-light: #3a3a4a;
      --text: #f4f4f5;
      --text-secondary: #a1a1aa;
      --text-muted: #71717a;
      --accent: #6366f1;
      --accent-hover: #818cf8;
      --accent-bg: rgba(99, 102, 241, 0.12);
      --accent-border: rgba(99, 102, 241, 0.3);
      --success: #10b981;
      --success-bg: rgba(16, 185, 129, 0.12);
      --warning: #f59e0b;
      --warning-bg: rgba(245, 158, 11, 0.12);
      --danger: #ef4444;
      --danger-bg: rgba(239, 68, 68, 0.12);
      --sidebar-w: 260px;
      --radius: 12px;
      --radius-sm: 8px;
    }
    * { box-sizing: border-box; margin: 0; padding: 0; }
    html, body { font-family: var(--font); background: var(--bg); color: var(--text); height: 100%; overflow: hidden; }

    .app { display: flex; height: 100vh; }
    .sidebar { width: var(--sidebar-w); background: var(--bg-sidebar); border-right: 1px solid var(--border); display: flex; flex-direction: column; flex-shrink: 0; overflow-y: auto; }
    .sidebar-header { padding: 20px; border-bottom: 1px solid var(--border); }
    .logo { display: flex; align-items: center; gap: 12px; font-weight: 800; font-size: 1.2rem; }
    .logo-icon { width: 38px; height: 38px; background: linear-gradient(135deg, var(--accent) 0%, #a855f7 100%); border-radius: 10px; display: flex; align-items: center; justify-content: center; font-size: 1.1rem; }
    .account-badge { margin-top: 12px; padding: 8px 12px; background: var(--bg-card); border-radius: var(--radius-sm); font-size: 0.75rem; color: var(--text-secondary); word-break: break-all; }
    .sidebar-nav { flex: 1; padding: 12px 10px; }
    .nav-section { padding: 14px 12px 6px; font-size: 0.68rem; font-weight: 700; text-transform: uppercase; letter-spacing: 1.2px; color: var(--text-muted); }
    .nav-item { display: flex; align-items: center; gap: 12px; padding: 11px 14px; border-radius: var(--radius-sm); color: var(--text-secondary); cursor: pointer; transition: all 0.15s; font-weight: 500; font-size: 0.9rem; margin-bottom: 2px; }
    .nav-item:hover { background: var(--bg-card); color: var(--text); }
    .nav-item.active { background: var(--accent-bg); color: var(--accent); border: 1px solid var(--accent-border); }
    .nav-icon { font-size: 1.1rem; width: 24px; text-align: center; }
    .nav-badge { margin-left: auto; background: var(--danger); color: white; font-size: 0.65rem; padding: 2px 6px; border-radius: 10px; font-weight: 700; }
    .sidebar-footer { padding: 16px; border-top: 1px solid var(--border); }
    .user-menu { display: flex; align-items: center; gap: 12px; padding: 12px; background: var(--bg-card); border-radius: var(--radius-sm); cursor: pointer; }
    .user-menu:hover { background: var(--bg-card-hover); }
    .user-avatar { width: 36px; height: 36px; background: linear-gradient(135deg, #f59e0b 0%, #ef4444 100%); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 700; font-size: 0.85rem; }
    .user-info { flex: 1; min-width: 0; }
    .user-name { font-weight: 600; font-size: 0.9rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .user-role { font-size: 0.75rem; color: var(--text-muted); }

    .main { flex: 1; display: flex; flex-direction: column; overflow: hidden; }
    .topbar { padding: 14px 28px; border-bottom: 1px solid var(--border); display: flex; align-items: center; justify-content: space-between; background: var(--bg-sidebar); flex-wrap: wrap; gap: 12px; }
    .page-title { font-size: 1.4rem; font-weight: 700; }
    .content { flex: 1; overflow-y: auto; padding: 28px; }

    .view { display: none; animation: fadeIn 0.2s ease; }
    .view.active { display: block; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(8px); } to { opacity: 1; transform: translateY(0); } }

    .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 14px; margin-bottom: 24px; }
    .stat-card { background: var(--bg-card); border: 1px solid var(--border); border-radius: var(--radius); padding: 18px; }
    .stat-card.accent { background: linear-gradient(135deg, var(--accent) 0%, #a855f7 100%); border: none; }
    .stat-label { font-size: 0.72rem; color: var(--text-muted); font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 6px; }
    .stat-card.accent .stat-label { color: rgba(255,255,255,0.8); }
    .stat-value { font-size: 1.7rem; font-weight: 800; line-height: 1; }
    .stat-card.accent .stat-value { color: white; }

    .card { background: var(--bg-card); border: 1px solid var(--border); border-radius: var(--radius); padding: 22px; margin-bottom: 18px; }
    .card-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 18px; flex-wrap: wrap; gap: 12px; }
    .card-title { font-size: 1.05rem; font-weight: 700; }

    .btn { display: inline-flex; align-items: center; gap: 8px; padding: 10px 18px; border-radius: var(--radius-sm); font-weight: 600; font-size: 0.88rem; cursor: pointer; transition: all 0.15s; border: 1px solid transparent; font-family: var(--font); }
    .btn-primary { background: var(--accent); color: white; }
    .btn-primary:hover { background: var(--accent-hover); }
    .btn-secondary { background: var(--bg-card); color: var(--text); border-color: var(--border); }
    .btn-secondary:hover { background: var(--bg-card-hover); }
    .btn-success { background: var(--success); color: white; }
    .btn-danger { background: var(--danger-bg); color: var(--danger); border-color: rgba(239, 68, 68, 0.3); }
    .btn-sm { padding: 6px 12px; font-size: 0.8rem; }
    .btn-icon { width: 32px; height: 32px; padding: 0; justify-content: center; }

    .form-group { margin-bottom: 16px; }
    .form-label { display: block; font-size: 0.85rem; font-weight: 600; color: var(--text-secondary); margin-bottom: 8px; }
    .form-input { width: 100%; padding: 12px 14px; background: var(--bg-input); border: 1px solid var(--border); border-radius: var(--radius-sm); color: var(--text); font-size: 0.95rem; font-family: var(--font); transition: all 0.15s; }
    .form-input:focus { outline: none; border-color: var(--accent); box-shadow: 0 0 0 3px var(--accent-bg); }
    .form-input::placeholder { color: var(--text-muted); }
    .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 14px; }
    .form-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(100px, 1fr)); gap: 12px; }

    .table-container { overflow-x: auto; border: 1px solid var(--border); border-radius: var(--radius); }
    table { width: 100%; border-collapse: collapse; min-width: 600px; }
    th, td { padding: 12px 14px; text-align: left; border-bottom: 1px solid var(--border); }
    th { background: var(--bg-sidebar); font-size: 0.7rem; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px; color: var(--text-muted); position: sticky; top: 0; }
    td { font-size: 0.88rem; }
    tr:hover td { background: var(--bg-card); }
    tr:last-child td { border-bottom: none; }

    .badge { display: inline-flex; align-items: center; gap: 4px; padding: 4px 10px; border-radius: 20px; font-size: 0.7rem; font-weight: 600; white-space: nowrap; }
    .badge-success { background: var(--success-bg); color: var(--success); }
    .badge-warning { background: var(--warning-bg); color: var(--warning); }
    .badge-danger { background: var(--danger-bg); color: var(--danger); }
    .badge-neutral { background: var(--bg-input); color: var(--text-secondary); border: 1px solid var(--border); }
    .badge-accent { background: var(--accent-bg); color: var(--accent); }

    .modal-overlay { position: fixed; inset: 0; background: rgba(0, 0, 0, 0.7); backdrop-filter: blur(4px); display: none; align-items: center; justify-content: center; z-index: 1000; padding: 20px; }
    .modal-overlay.open { display: flex; }
    .modal { background: var(--bg-card); border: 1px solid var(--border); border-radius: var(--radius); width: 100%; max-width: 560px; max-height: 90vh; overflow-y: auto; }
    .modal-header { padding: 18px 22px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; position: sticky; top: 0; background: var(--bg-card); z-index: 10; }
    .modal-title { font-size: 1.05rem; font-weight: 700; }
    .modal-close { width: 32px; height: 32px; border-radius: 50%; background: var(--bg-input); border: none; color: var(--text-secondary); cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 1.2rem; }
    .modal-close:hover { background: var(--danger-bg); color: var(--danger); }
    .modal-body { padding: 22px; }
    .modal-footer { padding: 16px 22px; border-top: 1px solid var(--border); display: flex; justify-content: flex-end; gap: 10px; position: sticky; bottom: 0; background: var(--bg-card); }

    .toast { position: fixed; bottom: 24px; right: 24px; background: var(--bg-card); border: 1px solid var(--border); padding: 14px 20px; border-radius: var(--radius-sm); display: flex; align-items: center; gap: 12px; transform: translateY(100px); opacity: 0; transition: all 0.3s; z-index: 2000; box-shadow: 0 10px 40px rgba(0,0,0,0.3); }
    .toast.show { transform: translateY(0); opacity: 1; }
    .toast.success { border-color: var(--success); }
    .toast.error { border-color: var(--danger); }

    .grid-cards { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 14px; }
    .item-card { background: var(--bg-card); border: 1px solid var(--border); border-radius: var(--radius); padding: 18px; cursor: pointer; transition: all 0.2s; }
    .item-card:hover { border-color: var(--accent-border); transform: translateY(-2px); }
    .item-card-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 8px; gap: 10px; }
    .item-card-title { font-weight: 700; font-size: 0.95rem; }
    .item-card-meta { font-size: 0.8rem; color: var(--text-muted); margin-top: 4px; }

    /* Stock Cards - Visual mejorado */
    .stock-grid-new { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 20px; }
    .stock-card-new { background: var(--bg-card); border: 1px solid var(--border); border-radius: 12px; padding: 20px; cursor: pointer; transition: all 0.2s; }
    .stock-card-new:hover { transform: translateY(-3px); border-color: var(--primary); }
    .stock-card-new.critical { border: 2px solid var(--danger); background: rgba(239, 68, 68, 0.05); }
    .stock-card-new.warning { border: 2px solid var(--warning); background: rgba(245, 158, 11, 0.05); }
    .stock-card-top { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 12px; }
    .stock-item-title { font-size: 1.1rem; font-weight: 700; color: var(--text); }
    .stock-badges { display: flex; gap: 5px; flex-wrap: wrap; }
    .stock-badge { font-size: 0.7rem; padding: 2px 8px; border-radius: 10px; font-weight: 600; }
    .stock-badge.min { background: var(--bg-input); color: var(--text-muted); }
    .stock-badge.price { background: rgba(59, 130, 246, 0.1); color: var(--primary); }
    .stock-badge.prop { background: rgba(245, 158, 11, 0.15); color: #b45309; }
    .stock-badge.gest { background: rgba(59, 130, 246, 0.1); color: var(--primary); }
    .stock-forecast { padding: 10px 12px; border-radius: 8px; font-size: 0.8rem; font-weight: 600; text-align: center; margin-bottom: 12px; display: flex; align-items: center; justify-content: center; gap: 6px; }
    .stock-forecast.ok { background: var(--success-bg); color: var(--success); }
    .stock-forecast.low { background: rgba(245, 158, 11, 0.15); color: #b45309; }
    .stock-forecast.critical { background: var(--danger-bg); color: var(--danger); }
    .stock-stat { text-align: center; margin: 15px 0; }
    .stock-val { font-size: 2.5rem; font-weight: 900; line-height: 1; }
    .stock-val.ok { color: var(--success); }
    .stock-val.low { color: var(--warning); }
    .stock-val.critical { color: var(--danger); }
    .stock-label { font-size: 0.75rem; text-transform: uppercase; letter-spacing: 1px; color: var(--text-muted); font-weight: 700; margin-top: 5px; }
    .stock-actions-new { display: flex; gap: 6px; justify-content: center; margin-top: 12px; }
    .stock-btn-new { background: var(--bg-input); border: 1px solid var(--border); color: var(--text-secondary); padding: 8px 14px; border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 0.9rem; transition: all 0.1s; }
    .stock-btn-new:hover { background: var(--bg-card-hover); border-color: var(--primary); color: var(--primary); }
    .stock-btn-new.neg:hover { border-color: var(--danger); color: var(--danger); }
    
    /* Stats boxes mejorados */
    .stock-stats-bar { display: flex; gap: 15px; margin-bottom: 25px; flex-wrap: wrap; }
    .stock-stat-box { background: var(--bg-card); border: 1px solid var(--border); border-radius: 10px; padding: 15px 20px; display: flex; align-items: center; gap: 12px; min-width: 140px; }
    .stock-stat-box.danger { border-color: var(--danger); background: rgba(239, 68, 68, 0.05); }
    .stock-stat-box.warning { border-color: var(--warning); background: rgba(245, 158, 11, 0.05); }
    .stock-stat-icon { font-size: 1.5rem; }
    .stock-stat-num { font-size: 1.5rem; font-weight: 800; }
    .stock-stat-label { font-size: 0.75rem; color: var(--text-muted); }
    
    /* Form section divider */
    .form-section-title { font-size: 0.8rem; color: var(--text-muted); margin: 20px 0 12px; padding-top: 16px; border-top: 1px solid var(--border); font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px; display: flex; align-items: center; gap: 8px; }
    .form-grid-4 { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
    @media (min-width: 600px) { .form-grid-4 { grid-template-columns: 1fr 1fr 1fr 1fr; } }

    .empty-state { text-align: center; padding: 50px 20px; color: var(--text-muted); }
    .empty-state-icon { font-size: 3rem; margin-bottom: 14px; opacity: 0.5; }
    .empty-state h3 { color: var(--text); margin-bottom: 8px; font-size: 1.1rem; }

    .login-container { min-height: 100vh; display: flex; align-items: center; justify-content: center; background: var(--bg); padding: 20px; }
    .login-box { width: 100%; max-width: 400px; background: var(--bg-card); border: 1px solid var(--border); border-radius: var(--radius); padding: 36px; }
    .login-logo { text-align: center; margin-bottom: 28px; }
    .login-logo .logo-icon { width: 60px; height: 60px; font-size: 1.6rem; margin: 0 auto 14px; }
    .login-logo h1 { font-size: 1.4rem; font-weight: 800; }
    .login-logo p { color: var(--text-muted); font-size: 0.88rem; margin-top: 4px; }
    .login-tabs { display: flex; gap: 4px; background: var(--bg-input); padding: 4px; border-radius: var(--radius-sm); margin-bottom: 22px; }
    .login-tab { flex: 1; padding: 10px; text-align: center; border-radius: 6px; font-weight: 600; font-size: 0.88rem; cursor: pointer; color: var(--text-muted); transition: all 0.15s; border: none; background: none; font-family: var(--font); }
    .login-tab.active { background: var(--accent); color: white; }
    .login-error { color: var(--danger); text-align: center; margin-top: 14px; font-size: 0.85rem; display: none; padding: 10px; background: var(--danger-bg); border-radius: var(--radius-sm); }

    .loader { width: 24px; height: 24px; border: 3px solid var(--border); border-top-color: var(--accent); border-radius: 50%; animation: spin 1s linear infinite; }
    @keyframes spin { to { transform: rotate(360deg); } }
    .loading-overlay { position: fixed; inset: 0; background: var(--bg); display: flex; align-items: center; justify-content: center; z-index: 9999; flex-direction: column; gap: 16px; }

    @media (max-width: 900px) {
      .sidebar { position: fixed; left: -280px; top: 0; bottom: 0; z-index: 100; transition: left 0.3s; }
      .sidebar.open { left: 0; }
      .mobile-toggle { display: flex !important; }
      .form-row { grid-template-columns: 1fr; }
      .content { padding: 16px; }
    }
    .mobile-toggle { display: none; width: 40px; height: 40px; align-items: center; justify-content: center; background: var(--bg-card); border: 1px solid var(--border); border-radius: var(--radius-sm); cursor: pointer; font-size: 1.2rem; }
    .mobile-overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 99; }
    .mobile-overlay.open { display: block; }

    .filters-bar { display: flex; gap: 12px; margin-bottom: 18px; flex-wrap: wrap; align-items: center; }
    .filters-bar select, .filters-bar input { padding: 10px 14px; background: var(--bg-input); border: 1px solid var(--border); border-radius: var(--radius-sm); color: var(--text); font-size: 0.88rem; font-family: var(--font); }

    /* Integration Cards */
    .integration-card { background: var(--bg-input); border: 1px solid var(--border); border-radius: var(--radius); padding: 20px; text-align: center; cursor: pointer; transition: all 0.2s; }
    .integration-card:hover { border-color: var(--accent-border); transform: translateY(-3px); box-shadow: 0 8px 20px rgba(0,0,0,0.2); }
    .integration-card.connected { border-color: var(--success); background: var(--success-bg); }
    .integration-icon { width: 56px; height: 56px; margin: 0 auto 12px; border-radius: 14px; display: flex; align-items: center; justify-content: center; font-weight: 800; font-size: 1.1rem; color: white; }
    .integration-name { font-weight: 700; font-size: 1rem; margin-bottom: 6px; }
    .integration-status { font-size: 0.75rem; color: var(--text-muted); }
    .integration-card.connected .integration-status { color: var(--success); }
    .integration-badge { display: inline-block; padding: 4px 10px; border-radius: 20px; font-size: 0.7rem; font-weight: 700; }
    .integration-badge.active { background: var(--success-bg); color: var(--success); }
    .integration-badge.inactive { background: var(--danger-bg); color: var(--danger); }
    .integration-badge.syncing { background: var(--warning-bg); color: var(--warning); }

    /* Servicios especÃ­ficos */
    .servicio-row { display: flex; align-items: center; gap: 12px; }
    .servicio-prop { font-weight: 700; }
    .servicio-time { font-size: 0.8rem; color: var(--text-muted); }
    .servicio-actions { display: flex; gap: 6px; }

    /* Forecast badges */
    .forecast-badge { display: inline-flex; align-items: center; gap: 6px; padding: 6px 12px; border-radius: 20px; font-size: 0.75rem; font-weight: 600; }
    .forecast-badge.ok { background: var(--success-bg); color: var(--success); }
    .forecast-badge.warning { background: var(--warning-bg); color: var(--warning); }
    .forecast-badge.danger { background: var(--danger-bg); color: var(--danger); }
    
    /* Consumos desglose */
    .consumo-item { display: flex; justify-content: space-between; padding: 10px 0; border-bottom: 1px solid var(--border); }
    .consumo-item:last-child { border-bottom: none; }
    .consumo-nombre { font-weight: 500; }
    .consumo-valor { font-weight: 700; color: var(--accent); }
    .consumo-pagador { font-size: 0.75rem; padding: 2px 8px; border-radius: 10px; margin-left: 8px; }
    .consumo-pagador.gestor { background: var(--accent-bg); color: var(--accent); }
    .consumo-pagador.propietario { background: var(--warning-bg); color: var(--warning); }
    
    /* Informe preview */
    .informe-section { margin-bottom: 20px; }
    .informe-section h4 { color: var(--accent); margin-bottom: 10px; }
    
    /* Alert config cards */
    .alert-config-card { background: var(--bg-input); padding: 18px; border-radius: var(--radius); }
    .alert-test-btn { margin-top: 12px; }
    .alert-status { padding: 10px; border-radius: var(--radius-sm); margin-top: 10px; font-size: 0.85rem; }
    .alert-status.success { background: var(--success-bg); color: var(--success); }
    .alert-status.error { background: var(--danger-bg); color: var(--danger); }
    
    /* WhatsApp preview */
    .whatsapp-preview { background: #075e54; color: white; padding: 15px; border-radius: var(--radius); font-family: monospace; font-size: 0.85rem; white-space: pre-wrap; margin-top: 10px; }
  </style>
</head>
<body>

<!-- LOADING -->
<div id="loading-overlay" class="loading-overlay">
  <div class="loader" style="width:44px; height:44px;"></div>
  <span style="color:var(--text-muted);">Cargando...</span>
</div>

<!-- LOGIN VIEW -->
<div id="login-view" class="login-container" style="display:none;">
  <div class="login-box">
    <div class="login-logo">
      <div class="logo-icon">ğŸ </div>
      <h1>CleanManager Pro</h1>
      <p>GestiÃ³n Integral de Limpiezas</p>
    </div>
    <div class="login-tabs">
      <button class="login-tab active" onclick="switchAuthTab('login')">Entrar</button>
      <button class="login-tab" onclick="switchAuthTab('register')">Registrarse</button>
    </div>
    
    <!-- Login Form -->
    <div id="form-login">
      <div class="form-group">
        <label class="form-label">Email</label>
        <input type="email" id="login-email" class="form-input" placeholder="tu@email.com">
      </div>
      <div class="form-group">
        <label class="form-label">ContraseÃ±a</label>
        <input type="password" id="login-password" class="form-input" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢">
      </div>
      <button class="btn btn-primary" style="width:100%;" onclick="doLogin()">
        Iniciar SesiÃ³n
      </button>
    </div>
    
    <!-- Register Form -->
    <div id="form-register" style="display:none;">
      <div class="form-group">
        <label class="form-label">Nombre de tu Empresa</label>
        <input type="text" id="reg-empresa" class="form-input" placeholder="Limpiezas Costa Sur">
      </div>
      <div class="form-group">
        <label class="form-label">Tu Nombre</label>
        <input type="text" id="reg-nombre" class="form-input" placeholder="MarÃ­a GarcÃ­a">
      </div>
      <div class="form-group">
        <label class="form-label">Email</label>
        <input type="email" id="reg-email" class="form-input" placeholder="tu@email.com">
      </div>
      <div class="form-group">
        <label class="form-label">TelÃ©fono</label>
        <input type="tel" id="reg-telefono" class="form-input" placeholder="612345678">
      </div>
      <div class="form-group">
        <label class="form-label">ContraseÃ±a (mÃ­n. 6 caracteres)</label>
        <input type="password" id="reg-password" class="form-input" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢">
      </div>
      <button class="btn btn-primary" style="width:100%;" onclick="doRegister()">
        Crear Cuenta
      </button>
    </div>
    
    <div id="auth-error" class="login-error"></div>
  </div>
</div>

<!-- MAIN APP -->
<div id="app-view" class="app" style="display:none;">
  <div class="mobile-overlay" id="mobile-overlay" onclick="toggleSidebar()"></div>
  
  <!-- SIDEBAR -->
  <aside class="sidebar" id="sidebar">
    <div class="sidebar-header">
      <div class="logo">
        <div class="logo-icon">ğŸ </div>
        <span>CleanManager</span>
      </div>
      <div class="account-badge" id="account-name">Mi Empresa</div>
    </div>
    <nav class="sidebar-nav">
      <div class="nav-section">Principal</div>
      <div class="nav-item active" data-view="dashboard" onclick="navigate('dashboard')">
        <span class="nav-icon">ğŸ“Š</span> Dashboard
      </div>
      <div class="nav-item" data-view="servicios" onclick="navigate('servicios')">
        <span class="nav-icon">ğŸ“…</span> Servicios
        <span class="nav-badge" id="servicios-badge" style="display:none;">0</span>
      </div>
      <div class="nav-item" data-view="reservas" onclick="navigate('reservas')">
        <span class="nav-icon">ğŸ›ï¸</span> Reservas
      </div>

      <div class="nav-section">Inventario</div>
      <div class="nav-item" data-view="stock" onclick="navigate('stock')">
        <span class="nav-icon">ğŸ“¦</span> Stock
        <span class="nav-badge" id="stock-alert-badge" style="display:none;">0</span>
      </div>
      <div class="nav-item" data-view="kits" onclick="navigate('kits')">
        <span class="nav-icon">ğŸ</span> Kits
      </div>

      <div class="nav-section">GestiÃ³n</div>
      <div class="nav-item" data-view="propiedades" onclick="navigate('propiedades')">
        <span class="nav-icon">ğŸ </span> Propiedades
      </div>
      <div class="nav-item" data-view="propietarios" onclick="navigate('propietarios')">
        <span class="nav-icon">ğŸ‘¤</span> Propietarios
      </div>
      <div class="nav-item" data-view="empleados" onclick="navigate('empleados')">
        <span class="nav-icon">ğŸ‘¥</span> Empleados
      </div>

      <div class="nav-section">Finanzas</div>
      <div class="nav-item" data-view="limpiezas" onclick="navigate('limpiezas')">
        <span class="nav-icon">ğŸ§¹</span> Limpiezas
      </div>
      <div class="nav-item" data-view="consumos" onclick="navigate('consumos')">
        <span class="nav-icon">ğŸ’°</span> Consumos
      </div>
      <div class="nav-item" data-view="extras" onclick="navigate('extras')">
        <span class="nav-icon">â•</span> Extras
      </div>
      <div class="nav-item" data-view="mantenimiento" onclick="navigate('mantenimiento')">
        <span class="nav-icon">ğŸ”§</span> Mantenimiento
      </div>
      <div class="nav-item" data-view="gastos" onclick="navigate('gastos')">
        <span class="nav-icon">ğŸ“‹</span> Gastos Fijos
      </div>
      <div class="nav-item" data-view="informes" onclick="navigate('informes')">
        <span class="nav-icon">ğŸ“„</span> Informes
      </div>

      <div class="nav-section">Sistema</div>
      <div class="nav-item" data-view="integraciones" onclick="navigate('integraciones')">
        <span class="nav-icon">ğŸ”—</span> Integraciones
      </div>
      <div class="nav-item" data-view="alertas" onclick="navigate('alertas')">
        <span class="nav-icon">ğŸ””</span> Alertas
      </div>
    </nav>
    <div class="sidebar-footer">
      <div class="user-menu" onclick="logout()">
        <div class="user-avatar" id="user-avatar">CM</div>
        <div class="user-info">
          <div class="user-name" id="user-name">Usuario</div>
          <div class="user-role">Cerrar sesiÃ³n â»</div>
        </div>
      </div>
    </div>
  </aside>

  <!-- MAIN -->
  <main class="main">
    <header class="topbar">
      <div style="display:flex; align-items:center; gap:14px;">
        <button class="mobile-toggle" onclick="toggleSidebar()">â˜°</button>
        <h1 class="page-title" id="page-title">Dashboard</h1>
      </div>
      <div id="topbar-actions"></div>
    </header>

    <div class="content">
      
      <!-- DASHBOARD -->
      <div id="view-dashboard" class="view active">
        <div class="stats-grid">
          <div class="stat-card accent">
            <div class="stat-label">Servicios Hoy</div>
            <div class="stat-value" id="stat-hoy">0</div>
          </div>
          <div class="stat-card">
            <div class="stat-label">Pendientes</div>
            <div class="stat-value" id="stat-pendientes">0</div>
          </div>
          <div class="stat-card">
            <div class="stat-label">Propiedades</div>
            <div class="stat-value" id="stat-props">0</div>
          </div>
          <div class="stat-card">
            <div class="stat-label">Stock Bajo</div>
            <div class="stat-value" id="stat-stock-bajo" style="color:var(--danger);">0</div>
          </div>
        </div>

        <div style="display:grid; grid-template-columns:repeat(auto-fit, minmax(320px, 1fr)); gap:18px;">
          <div class="card">
            <div class="card-header">
              <h3 class="card-title">ğŸ“… PrÃ³ximos Servicios</h3>
              <button class="btn btn-sm btn-secondary" onclick="navigate('servicios')">Ver todos</button>
            </div>
            <div id="dash-servicios"></div>
          </div>
          <div class="card">
            <div class="card-header">
              <h3 class="card-title">âš ï¸ Alertas</h3>
            </div>
            <div id="dash-alertas"></div>
          </div>
        </div>
      </div>

      <!-- SERVICIOS -->
      <div id="view-servicios" class="view">
        <div class="card">
          <div class="card-header">
            <h3 class="card-title">ğŸ“… Servicios de Limpieza</h3>
            <button class="btn btn-primary" onclick="openModal('modal-servicio')">+ Nuevo Servicio</button>
          </div>
          <div class="filters-bar">
            <input type="date" id="serv-fecha" onchange="renderServicios()">
            <select id="serv-estado" onchange="renderServicios()">
              <option value="">Todos los estados</option>
              <option value="pendiente">ğŸŸ¡ Pendiente</option>
              <option value="confirmado">ğŸ”µ Confirmado</option>
              <option value="en_proceso">ğŸŸ  En proceso</option>
              <option value="completado">ğŸŸ¢ Completado</option>
              <option value="cancelado">ğŸ”´ Cancelado</option>
            </select>
            <select id="serv-propiedad" onchange="renderServicios()">
              <option value="">Todas las propiedades</option>
            </select>
          </div>
          <div class="table-container">
            <table>
              <thead>
                <tr>
                  <th>Fecha</th>
                  <th>Hora</th>
                  <th>Propiedad</th>
                  <th>Tipo</th>
                  <th>HuÃ©sped</th>
                  <th>Asignado</th>
                  <th>Estado</th>
                  <th>Acciones</th>
                </tr>
              </thead>
              <tbody id="servicios-tbody"></tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- RESERVAS -->
      <div id="view-reservas" class="view">
        <div class="card">
          <div class="card-header">
            <h3 class="card-title">ğŸ›ï¸ Reservas</h3>
            <div style="display:flex; gap:8px;">
              <button class="btn btn-secondary" onclick="syncAllReservas()">ğŸ”„ Sincronizar</button>
            </div>
          </div>
          <div class="filters-bar">
            <input type="date" id="res-desde" onchange="renderReservas()">
            <input type="date" id="res-hasta" onchange="renderReservas()">
            <select id="res-origen" onchange="renderReservas()">
              <option value="">Todos los orÃ­genes</option>
              <option value="avaibook">Avaibook</option>
              <option value="icnea">Icnea</option>
              <option value="hostify">Hostify</option>
              <option value="manual">Manual</option>
            </select>
            <select id="res-status" onchange="renderReservas()">
              <option value="">Todos los estados</option>
              <option value="confirmed">âœ… Confirmada</option>
              <option value="pending">â³ Pendiente</option>
              <option value="cancelled">âŒ Cancelada</option>
            </select>
          </div>
          <div class="table-container">
            <table>
              <thead>
                <tr>
                  <th>Check-in</th>
                  <th>Check-out</th>
                  <th>Propiedad</th>
                  <th>HuÃ©sped</th>
                  <th>HuÃ©spedes</th>
                  <th>Canal</th>
                  <th>Estado</th>
                  <th>Precio</th>
                </tr>
              </thead>
              <tbody id="reservas-tbody"></tbody>
            </table>
            <div id="reservas-empty" class="empty-state" style="display:none;">
              <span style="font-size:2rem;">ğŸ›ï¸</span>
              <p>No hay reservas. Conecta un PMS en Integraciones.</p>
            </div>
          </div>
        </div>
      </div>

      <!-- STOCK -->
      <div id="view-stock" class="view">
        <div class="card">
          <div class="card-header">
            <h3 class="card-title">ğŸ“¦ Inventario</h3>
            <button class="btn btn-primary" onclick="openStockModal()">+ Nuevo ArtÃ­culo</button>
          </div>
          <div class="stock-stats-bar" id="stock-stats-bar">
            <div class="stock-stat-box danger">
              <span class="stock-stat-icon">ğŸš¨</span>
              <div><div class="stock-stat-num" id="stat-bajo-min">0</div><div class="stock-stat-label">Bajo mÃ­nimo</div></div>
            </div>
            <div class="stock-stat-box warning">
              <span class="stock-stat-icon">âš ï¸</span>
              <div><div class="stock-stat-num" id="stat-agotaran">0</div><div class="stock-stat-label">Se agotarÃ¡n</div></div>
            </div>
            <div class="stock-stat-box">
              <span class="stock-stat-icon">âœ…</span>
              <div><div class="stock-stat-num" id="stat-ok">0</div><div class="stock-stat-label">OK</div></div>
            </div>
            <div class="stock-stat-box">
              <span class="stock-stat-icon">ğŸ“…</span>
              <div><div class="stock-stat-num" id="stat-reservas-futuras">0</div><div class="stock-stat-label">Reservas futuras</div></div>
            </div>
          </div>
          <div id="stock-grid" class="stock-grid-new"></div>
        </div>
      </div>

      <!-- KITS -->
      <div id="view-kits" class="view">
        <div class="card">
          <div class="card-header">
            <h3 class="card-title">ğŸ Kits de Productos</h3>
            <button class="btn btn-primary" onclick="openModal('modal-kit')">+ Nuevo Kit</button>
          </div>
          <div id="kits-grid" class="grid-cards"></div>
        </div>
      </div>

      <!-- PROPIEDADES -->
      <div id="view-propiedades" class="view">
        <div class="card">
          <div class="card-header">
            <h3 class="card-title">ğŸ  Propiedades</h3>
            <button class="btn btn-primary" onclick="openModal('modal-propiedad')">+ Nueva Propiedad</button>
          </div>
          <div id="propiedades-grid" class="grid-cards"></div>
        </div>
      </div>

      <!-- PROPIETARIOS -->
      <div id="view-propietarios" class="view">
        <div class="card">
          <div class="card-header">
            <h3 class="card-title">ğŸ‘¤ Propietarios</h3>
            <button class="btn btn-primary" onclick="openModal('modal-propietario')">+ Nuevo Propietario</button>
          </div>
          <div id="propietarios-grid" class="grid-cards"></div>
        </div>
      </div>

      <!-- EMPLEADOS -->
      <div id="view-empleados" class="view">
        <div class="card">
          <div class="card-header">
            <h3 class="card-title">ğŸ‘¥ Equipo</h3>
            <button class="btn btn-primary" onclick="openModal('modal-empleado')">+ Nuevo Empleado</button>
          </div>
          <div id="empleados-grid" class="grid-cards"></div>
        </div>
      </div>

      <!-- EXTRAS -->
      <div id="view-extras" class="view">
        <div class="card">
          <div class="card-header">
            <h3 class="card-title">ğŸ§¹ Extras de Limpieza</h3>
            <button class="btn btn-primary" onclick="openModal('modal-extra')">+ Nuevo Extra</button>
          </div>
          <div class="filters-bar">
            <select id="extras-mes" onchange="renderExtras()"></select>
          </div>
          <div class="table-container">
            <table>
              <thead><tr><th>Fecha</th><th>Propiedad</th><th>Concepto</th><th>Importe</th><th></th></tr></thead>
              <tbody id="extras-tbody"></tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- MANTENIMIENTO -->
      <div id="view-mantenimiento" class="view">
        <div class="card">
          <div class="card-header">
            <h3 class="card-title">ğŸ”§ Mantenimiento</h3>
            <button class="btn btn-primary" onclick="openModal('modal-mantenimiento')">+ Nueva Incidencia</button>
          </div>
          <div class="filters-bar">
            <select id="mant-estado" onchange="renderMantenimiento()">
              <option value="">Todos</option>
              <option value="pendiente">ğŸŸ¡ Pendientes</option>
              <option value="resuelto">ğŸŸ¢ Resueltos</option>
            </select>
          </div>
          <div id="mantenimiento-grid" class="grid-cards"></div>
        </div>
      </div>

      <!-- GASTOS -->
      <div id="view-gastos" class="view">
        <div class="card">
          <div class="card-header">
            <h3 class="card-title">ğŸ“‹ Gastos Fijos</h3>
            <button class="btn btn-primary" onclick="openModal('modal-gasto')">+ Nuevo Gasto</button>
          </div>
          <div class="filters-bar">
            <select id="gastos-mes" onchange="renderGastos()"></select>
            <select id="gastos-tipo" onchange="renderGastos()">
              <option value="">Todos</option>
              <option value="luz">ğŸ’¡ Luz</option>
              <option value="agua">ğŸ’§ Agua</option>
              <option value="gas">ğŸ”¥ Gas</option>
              <option value="comunidad">ğŸ¢ Comunidad</option>
              <option value="internet">ğŸ“¶ Internet</option>
              <option value="otro">ğŸ“ Otro</option>
            </select>
          </div>
          <div class="table-container">
            <table>
              <thead><tr><th>Fecha</th><th>Propiedad</th><th>Tipo</th><th>Concepto</th><th>Importe</th><th>Paga</th><th></th></tr></thead>
              <tbody id="gastos-tbody"></tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- ALERTAS -->
      <div id="view-alertas" class="view">
        <div class="stats-grid">
          <div class="stat-card">
            <div class="stat-label">ğŸš¨ ArtÃ­culos bajo mÃ­nimo</div>
            <div class="stat-value" id="alert-bajo-min">0</div>
          </div>
          <div class="stat-card">
            <div class="stat-label">âš ï¸ Se agotarÃ¡n pronto</div>
            <div class="stat-value" id="alert-agotaran">0</div>
          </div>
          <div class="stat-card">
            <div class="stat-label">âœ… Stock OK</div>
            <div class="stat-value" id="alert-ok">0</div>
          </div>
        </div>
        <div style="display:grid; grid-template-columns:repeat(auto-fit, minmax(320px, 1fr)); gap:18px;">
          <div class="card">
            <div class="card-header">
              <h3 class="card-title">ğŸ“± WhatsApp Alertas</h3>
              <button class="btn btn-primary" onclick="saveAlertConfig()">ğŸ’¾ Guardar</button>
            </div>
            <div class="form-group">
              <label class="form-label">NÃºmero WhatsApp</label>
              <input type="tel" id="alert-whatsapp" class="form-input" placeholder="34612345678">
              <small style="color:var(--text-muted);">Formato: cÃ³digo paÃ­s + nÃºmero (sin +)</small>
            </div>
            <div class="form-group">
              <label class="form-label">Email (opcional)</label>
              <input type="email" id="alert-email" class="form-input">
            </div>
            <div style="margin-top:16px;">
              <h4 style="margin-bottom:10px;">âš™ï¸ Tipos de alerta</h4>
              <label style="display:flex; align-items:center; gap:10px; margin-bottom:10px; cursor:pointer;">
                <input type="checkbox" id="alert-stock" checked> âš ï¸ Stock bajo mÃ­nimo
              </label>
              <label style="display:flex; align-items:center; gap:10px; margin-bottom:10px; cursor:pointer;">
                <input type="checkbox" id="alert-rotura"> ğŸš¨ PredicciÃ³n de rotura stock
              </label>
              <div class="form-group" style="margin-left:26px;">
                <label class="form-label">DÃ­as de antelaciÃ³n</label>
                <input type="number" id="alert-dias-rotura" class="form-input" value="7" min="1" max="30" style="max-width:100px;">
              </div>
              <label style="display:flex; align-items:center; gap:10px; cursor:pointer;">
                <input type="checkbox" id="alert-semanal"> ğŸ“… Resumen semanal
              </label>
            </div>
            <div style="margin-top:16px; display:flex; gap:10px;">
              <button class="btn btn-secondary" onclick="testWhatsApp()">ğŸ§ª Probar WhatsApp</button>
              <button class="btn btn-success" onclick="sendAlertaNow()">ğŸ“¤ Enviar alerta ahora</button>
            </div>
            <div id="whatsapp-status"></div>
          </div>
          <div class="card">
            <div class="card-header">
              <h3 class="card-title">ğŸ‘ï¸ Vista previa del mensaje</h3>
            </div>
            <div class="whatsapp-preview" id="alert-preview">âš ï¸ *ALERTA DE STOCK*

Cargando estado del inventario...</div>
            <div style="margin-top:16px;">
              <h4 style="margin-bottom:10px;">ğŸ“Š Estado actual</h4>
              <div id="alertas-estado-actual"></div>
            </div>
          </div>
        </div>
      </div>

      <!-- LIMPIEZAS MENSUALES -->
      <div id="view-limpiezas" class="view">
        <div class="card">
          <div class="card-header">
            <h3 class="card-title">ğŸ§¹ Limpiezas del Mes</h3>
            <div style="display:flex; gap:10px; align-items:center;">
              <button class="btn btn-secondary btn-sm" onclick="changeMonth(-1)">â—€ Anterior</button>
              <span id="limpiezas-mes-label" style="font-weight:600; min-width:120px; text-align:center;">Diciembre 2024</span>
              <button class="btn btn-secondary btn-sm" onclick="changeMonth(1)">Siguiente â–¶</button>
            </div>
          </div>
          <div class="filters-bar">
            <select id="limpiezas-propietario" class="form-input" style="max-width:200px;" onchange="renderLimpiezasMes()">
              <option value="">Todos los propietarios</option>
            </select>
          </div>
          <div class="stats-grid" style="margin-top:16px;">
            <div class="stat-card">
              <div class="stat-label">Total Limpiezas</div>
              <div class="stat-value" id="limp-total">0</div>
            </div>
            <div class="stat-card">
              <div class="stat-label">Coste Gestor</div>
              <div class="stat-value" id="limp-gestor" style="color:var(--accent);">0â‚¬</div>
            </div>
            <div class="stat-card">
              <div class="stat-label">Coste Propietario</div>
              <div class="stat-value" id="limp-propietario" style="color:var(--warning);">0â‚¬</div>
            </div>
            <div class="stat-card accent">
              <div class="stat-label">Total</div>
              <div class="stat-value" id="limp-total-cost">0â‚¬</div>
            </div>
          </div>
          <div class="table-container" style="margin-top:16px;">
            <table>
              <thead>
                <tr>
                  <th>Fecha</th>
                  <th>Propiedad</th>
                  <th>Tipo</th>
                  <th>Precio Base</th>
                  <th>Extras</th>
                  <th>Total</th>
                  <th>Paga</th>
                  <th></th>
                </tr>
              </thead>
              <tbody id="limpiezas-table"></tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- CONSUMOS -->
      <div id="view-consumos" class="view">
        <div class="card">
          <div class="card-header">
            <h3 class="card-title">ğŸ’° Consumos del Mes</h3>
            <div style="display:flex; gap:10px; align-items:center;">
              <button class="btn btn-secondary btn-sm" onclick="changeConsumosMes(-1)">â—€ Anterior</button>
              <span id="consumos-mes-label" style="font-weight:600; min-width:120px; text-align:center;">Diciembre 2024</span>
              <button class="btn btn-secondary btn-sm" onclick="changeConsumosMes(1)">Siguiente â–¶</button>
            </div>
          </div>
          <div class="stats-grid">
            <div class="stat-card accent">
              <div class="stat-label">Gasto Total</div>
              <div class="stat-value" id="consumo-total">0â‚¬</div>
            </div>
            <div class="stat-card">
              <div class="stat-label">Reservas Atendidas</div>
              <div class="stat-value" id="consumo-reservas">0</div>
            </div>
            <div class="stat-card">
              <div class="stat-label">Paga Gestor</div>
              <div class="stat-value" id="consumo-gestor" style="color:var(--accent);">0â‚¬</div>
            </div>
            <div class="stat-card">
              <div class="stat-label">Paga Propietario</div>
              <div class="stat-value" id="consumo-propietario" style="color:var(--warning);">0â‚¬</div>
            </div>
          </div>
          <div style="display:grid; grid-template-columns:1fr 1fr; gap:18px; margin-top:18px;">
            <div class="card" style="margin:0;">
              <h4 style="margin-bottom:14px;">ğŸ“Š Tendencia 6 meses</h4>
              <canvas id="consumos-chart" height="200"></canvas>
            </div>
            <div class="card" style="margin:0;">
              <h4 style="margin-bottom:14px;">ğŸ“‹ Desglose por artÃ­culo</h4>
              <div id="consumos-desglose" style="max-height:280px; overflow-y:auto;"></div>
            </div>
          </div>
          <div class="card" style="margin-top:18px;">
            <h4 style="margin-bottom:14px;">ğŸ”® ProyecciÃ³n resto del mes</h4>
            <div id="consumos-proyeccion"></div>
          </div>
        </div>
      </div>

      <!-- INFORMES -->
      <div id="view-informes" class="view">
        <div class="stats-grid">
          <div class="stat-card" style="cursor:pointer;" onclick="exportPDFMensual()">
            <div class="stat-label">ğŸ“„ PDF Mensual</div>
            <div class="stat-value" style="font-size:2rem;">ğŸ“Š</div>
          </div>
          <div class="stat-card" style="cursor:pointer;" onclick="exportExcelCompleto()">
            <div class="stat-label">ğŸ“— Excel Completo</div>
            <div class="stat-value" style="font-size:2rem;">ğŸ“‘</div>
          </div>
          <div class="stat-card" style="cursor:pointer;" onclick="openInformePropietario()">
            <div class="stat-label">ğŸ‘¤ Informe Propietario</div>
            <div class="stat-value" style="font-size:2rem;">ğŸ“‹</div>
          </div>
        </div>
        <div style="display:grid; grid-template-columns:1fr 1fr; gap:18px;">
          <div class="card">
            <div class="card-header">
              <h3 class="card-title">ğŸ“„ Generar Informe PDF</h3>
            </div>
            <div class="form-group">
              <label class="form-label">Mes</label>
              <input type="month" id="informe-mes" class="form-input">
            </div>
            <div class="form-group">
              <label class="form-label">Tipo de informe</label>
              <select id="informe-tipo" class="form-input">
                <option value="mensual">ğŸ“Š Resumen Mensual</option>
                <option value="propietario">ğŸ‘¤ Por Propietario</option>
                <option value="consumos">ğŸ’° Consumos Detallado</option>
                <option value="limpiezas">ğŸ§¹ Limpiezas Detallado</option>
              </select>
            </div>
            <div class="form-group" id="informe-propietario-select" style="display:none;">
              <label class="form-label">Propietario</label>
              <select id="informe-propietario" class="form-input"></select>
            </div>
            <button class="btn btn-primary" onclick="generarInformePDF()" style="width:100%;">ğŸ“„ Generar PDF</button>
          </div>
          <div class="card">
            <div class="card-header">
              <h3 class="card-title">ğŸ“— Exportar Excel</h3>
            </div>
            <div class="form-group">
              <label class="form-label">Mes</label>
              <input type="month" id="excel-mes" class="form-input">
            </div>
            <div class="form-group">
              <label class="form-label">Contenido</label>
              <select id="excel-tipo" class="form-input">
                <option value="completo">ğŸ“‘ Todo (Inventario + Gastos + Limpiezas)</option>
                <option value="inventario">ğŸ“¦ Solo Inventario</option>
                <option value="gastos">ğŸ’° Solo Gastos/Consumos</option>
                <option value="limpiezas">ğŸ§¹ Solo Limpiezas</option>
                <option value="propietarios">ğŸ‘¤ Resumen Propietarios</option>
              </select>
            </div>
            <button class="btn btn-success" onclick="exportarExcel()" style="width:100%;">ğŸ“— Descargar Excel</button>
          </div>
        </div>
        <div class="card" style="margin-top:18px;">
          <div class="card-header">
            <h3 class="card-title">ğŸ‘ï¸ Vista previa</h3>
          </div>
          <div id="informe-preview" style="background:var(--bg-input); padding:20px; border-radius:var(--radius); min-height:200px; font-family:monospace; font-size:0.85rem; white-space:pre-wrap;">
Selecciona un tipo de informe y haz clic en generar para ver la vista previa.
          </div>
        </div>
      </div>

      <!-- INTEGRACIONES -->
      <div id="view-integraciones" class="view">
        <div class="stats-grid">
          <div class="stat-card accent">
            <div class="stat-label">Integraciones Activas</div>
            <div class="stat-value" id="stat-integraciones">0</div>
          </div>
          <div class="stat-card">
            <div class="stat-label">Propiedades Importadas</div>
            <div class="stat-value" id="stat-props-importadas">0</div>
          </div>
          <div class="stat-card">
            <div class="stat-label">Ãšltima SincronizaciÃ³n</div>
            <div class="stat-value" id="stat-last-sync" style="font-size:1rem;">-</div>
          </div>
        </div>

        <div class="card">
          <div class="card-header">
            <h3 class="card-title">ğŸ”— Conectar Plataforma</h3>
          </div>
          <div class="integration-platforms" style="display:grid; grid-template-columns:repeat(auto-fit, minmax(180px, 1fr)); gap:14px;">
            <div class="integration-card" onclick="openIntegrationModal('avaibook')">
              <div class="integration-icon" style="background:linear-gradient(135deg, #667eea, #764ba2);">AB</div>
              <div class="integration-name">Avaibook</div>
              <div class="integration-status" id="status-avaibook">No conectado</div>
            </div>
            <div class="integration-card" onclick="openIntegrationModal('icnea')">
              <div class="integration-icon" style="background:linear-gradient(135deg, #11998e, #38ef7d);">IC</div>
              <div class="integration-name">Icnea</div>
              <div class="integration-status" id="status-icnea">No conectado</div>
            </div>
            <div class="integration-card" onclick="openIntegrationModal('hostify')">
              <div class="integration-icon" style="background:linear-gradient(135deg, #ee0979, #ff6a00);">HF</div>
              <div class="integration-name">Hostify</div>
              <div class="integration-status" id="status-hostify">No conectado</div>
            </div>
            <div class="integration-card" onclick="openIntegrationModal('guesty')">
              <div class="integration-icon" style="background:linear-gradient(135deg, #4facfe, #00f2fe);">GY</div>
              <div class="integration-name">Guesty</div>
              <div class="integration-status" id="status-guesty">No conectado</div>
            </div>
            <div class="integration-card" onclick="openIntegrationModal('smoobu')">
              <div class="integration-icon" style="background:linear-gradient(135deg, #fa709a, #fee140);">SM</div>
              <div class="integration-name">Smoobu</div>
              <div class="integration-status" id="status-smoobu">No conectado</div>
            </div>
            <div class="integration-card" onclick="openIntegrationModal('lodgify')">
              <div class="integration-icon" style="background:linear-gradient(135deg, #a8edea, #fed6e3);">LG</div>
              <div class="integration-name">Lodgify</div>
              <div class="integration-status" id="status-lodgify">No conectado</div>
            </div>
          </div>
        </div>

        <div class="card">
          <div class="card-header">
            <h3 class="card-title">ğŸ“‹ Integraciones Activas</h3>
          </div>
          <div class="table-container">
            <table>
              <thead>
                <tr>
                  <th>Plataforma</th>
                  <th>Estado</th>
                  <th>Propiedades</th>
                  <th>Ãšltima Sync</th>
                  <th>Acciones</th>
                </tr>
              </thead>
              <tbody id="integraciones-tbody"></tbody>
            </table>
          </div>
          <div id="integraciones-empty" class="empty-state" style="display:none;">
            <span style="font-size:3rem;">ğŸ”—</span>
            <p>No hay integraciones activas</p>
            <p style="font-size:0.85rem; color:var(--text-muted);">Conecta tu PMS para importar propiedades y reservas automÃ¡ticamente</p>
          </div>
        </div>

        <div class="card">
          <div class="card-header">
            <h3 class="card-title">ğŸ  Propiedades Importadas</h3>
            <button class="btn btn-secondary" onclick="syncAllProperties()">ğŸ”„ Sincronizar Todas</button>
          </div>
          <div class="table-container">
            <table>
              <thead>
                <tr>
                  <th>Propiedad</th>
                  <th>Origen</th>
                  <th>ID Externo</th>
                  <th>Habitaciones</th>
                  <th>Camas</th>
                  <th>Precio Limpieza</th>
                  <th></th>
                </tr>
              </thead>
              <tbody id="props-importadas-tbody"></tbody>
            </table>
          </div>
        </div>
      </div>

    </div>
  </main>
</div>

<!-- MODALES -->

<!-- Modal Servicio -->
<div id="modal-servicio" class="modal-overlay">
  <div class="modal">
    <div class="modal-header">
      <h3 class="modal-title">ğŸ“… Nuevo Servicio</h3>
      <button class="modal-close" onclick="closeModal('modal-servicio')">Ã—</button>
    </div>
    <div class="modal-body">
      <input type="hidden" id="serv-edit-id">
      <div class="form-row">
        <div class="form-group">
          <label class="form-label">Propiedad *</label>
          <select id="serv-propiedad-sel" class="form-input"></select>
        </div>
        <div class="form-group">
          <label class="form-label">Tipo de Servicio</label>
          <select id="serv-tipo" class="form-input">
            <option value="checkout">ğŸšª Check-out</option>
            <option value="checkin">ğŸ”‘ Check-in</option>
            <option value="refresh">âœ¨ Refresh</option>
            <option value="profunda">ğŸ§½ Profunda</option>
            <option value="mantenimiento">ğŸ”§ Mantenimiento</option>
            <option value="otro">ğŸ“‹ Otro</option>
          </select>
        </div>
      </div>
      <div class="form-row">
        <div class="form-group">
          <label class="form-label">Fecha del Servicio *</label>
          <input type="date" id="serv-fecha-input" class="form-input">
        </div>
        <div class="form-group">
          <label class="form-label">Hora Inicio</label>
          <input type="time" id="serv-hora" class="form-input" value="11:00">
        </div>
      </div>
      <div class="form-row">
        <div class="form-group">
          <label class="form-label">Check-in HuÃ©sped</label>
          <input type="date" id="serv-checkin" class="form-input">
        </div>
        <div class="form-group">
          <label class="form-label">Check-out HuÃ©sped</label>
          <input type="date" id="serv-checkout" class="form-input">
        </div>
      </div>
      <div class="form-row">
        <div class="form-group">
          <label class="form-label">Nombre HuÃ©sped</label>
          <input type="text" id="serv-huesped" class="form-input" placeholder="Nombre del huÃ©sped">
        </div>
        <div class="form-group">
          <label class="form-label">NÂº HuÃ©spedes</label>
          <input type="number" id="serv-num-huespedes" class="form-input" value="2">
        </div>
      </div>
      <div class="form-row">
        <div class="form-group">
          <label class="form-label">Asignar a</label>
          <select id="serv-empleado" class="form-input"></select>
        </div>
        <div class="form-group">
          <label class="form-label">Precio (â‚¬)</label>
          <input type="number" id="serv-precio" class="form-input" step="0.01">
        </div>
      </div>
      <div class="form-row">
        <div class="form-group">
          <label class="form-label">Estado</label>
          <select id="serv-estado-sel" class="form-input">
            <option value="pendiente">ğŸŸ¡ Pendiente</option>
            <option value="confirmado">ğŸ”µ Confirmado</option>
            <option value="en_proceso">ğŸŸ  En proceso</option>
            <option value="completado">ğŸŸ¢ Completado</option>
            <option value="cancelado">ğŸ”´ Cancelado</option>
          </select>
        </div>
        <div class="form-group">
          <label class="form-label">Prioridad</label>
          <select id="serv-prioridad" class="form-input">
            <option value="normal">Normal</option>
            <option value="alta">âš¡ Alta</option>
            <option value="urgente">ğŸš¨ Urgente</option>
          </select>
        </div>
      </div>
      <div class="form-group">
        <label class="form-label">Notas</label>
        <textarea id="serv-notas" class="form-input" rows="2" placeholder="Instrucciones especiales..."></textarea>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-secondary" onclick="closeModal('modal-servicio')">Cancelar</button>
      <button class="btn btn-primary" onclick="saveServicio()">Guardar</button>
    </div>
  </div>
</div>

<!-- Modal Stock -->
<div id="modal-stock" class="modal-overlay">
  <div class="modal" style="max-width: 480px;">
    <div class="modal-header">
      <h3 class="modal-title" id="stock-modal-title">ğŸ“¦ Nuevo ArtÃ­culo</h3>
      <button class="modal-close" onclick="closeModal('modal-stock')">Ã—</button>
    </div>
    <div class="modal-body">
      <input type="hidden" id="stock-edit-id">
      <div class="form-group">
        <label class="form-label">Nombre del ArtÃ­culo *</label>
        <input type="text" id="stock-item" class="form-input" placeholder="Ej: Toalla de BaÃ±o">
      </div>
      <div class="form-row">
        <div class="form-group">
          <label class="form-label">Stock Actual</label>
          <input type="number" id="stock-qty" class="form-input" value="0">
        </div>
        <div class="form-group">
          <label class="form-label">Stock MÃ­nimo (alerta)</label>
          <input type="number" id="stock-min" class="form-input" value="10">
        </div>
      </div>
      <div class="form-row">
        <div class="form-group">
          <label class="form-label">ğŸ’¶ Precio por Unidad (â‚¬)</label>
          <input type="number" id="stock-precio" class="form-input" value="0" step="0.01" placeholder="0.00">
        </div>
        <div class="form-group">
          <label class="form-label">ğŸ’³ Â¿QuiÃ©n paga?</label>
          <select id="stock-pagador" class="form-input">
            <option value="gestor">ğŸ¢ Gestor</option>
            <option value="propietario">ğŸ‘¤ Propietario</option>
          </select>
        </div>
      </div>
      
      <div class="form-section-title">ğŸ“ CONSUMO POR LIMPIEZA</div>
      <div class="form-group">
        <label class="form-label">ğŸ§¹ Fijo por limpieza (amenities, agua, etc)</label>
        <input type="number" id="stock-c-limp" class="form-input" value="0">
      </div>
      <div class="form-grid-4">
        <div class="form-group"><label class="form-label">ğŸšª x HabitaciÃ³n</label><input type="number" id="stock-c-hab" class="form-input" value="0"></div>
        <div class="form-group"><label class="form-label">ğŸš¿ x BaÃ±o</label><input type="number" id="stock-c-bano" class="form-input" value="0"></div>
        <div class="form-group"><label class="form-label">ğŸ›ï¸ x Cama Doble</label><input type="number" id="stock-c-cama-doble" class="form-input" value="0"></div>
        <div class="form-group"><label class="form-label">ğŸ›ï¸ x Cama Individual</label><input type="number" id="stock-c-cama-indiv" class="form-input" value="0"></div>
      </div>
      <div class="form-grid-4">
        <div class="form-group"><label class="form-label">ğŸ§‘ x Adulto</label><input type="number" id="stock-c-adulto" class="form-input" value="0"></div>
        <div class="form-group"><label class="form-label">ğŸ‘¦ x NiÃ±o</label><input type="number" id="stock-c-nino" class="form-input" value="0"></div>
        <div class="form-group"><label class="form-label">ğŸ‘¶ x BebÃ©</label><input type="number" id="stock-c-bebe" class="form-input" value="0"></div>
        <div class="form-group"><label class="form-label">ğŸ‘¤ x HuÃ©sped (total)</label><input type="number" id="stock-c-huesp" class="form-input" value="0"></div>
      </div>
    </div>
    <div class="modal-footer" style="justify-content: space-between;">
      <button class="btn btn-danger" id="stock-btn-delete" onclick="deleteStock()" style="display:none;">ğŸ—‘ï¸ Eliminar</button>
      <div style="display:flex; gap:10px;">
        <button class="btn btn-secondary" onclick="closeModal('modal-stock')">Cancelar</button>
        <button class="btn btn-primary" onclick="saveStock()">ğŸ’¾ Guardar</button>
      </div>
    </div>
  </div>
</div>

<!-- Modal Propiedad -->
<div id="modal-propiedad" class="modal-overlay">
  <div class="modal">
    <div class="modal-header">
      <h3 class="modal-title">ğŸ  Nueva Propiedad</h3>
      <button class="modal-close" onclick="closeModal('modal-propiedad')">Ã—</button>
    </div>
    <div class="modal-body">
      <div class="form-group">
        <label class="form-label">Nombre *</label>
        <input type="text" id="prop-nombre" class="form-input" placeholder="Apartamento Centro">
      </div>
      <div class="form-group">
        <label class="form-label">Precio Limpieza (â‚¬)</label>
        <input type="number" id="prop-precio" class="form-input" value="45" step="0.01">
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-secondary" onclick="closeModal('modal-propiedad')">Cancelar</button>
      <button class="btn btn-primary" onclick="savePropiedad()">Guardar</button>
    </div>
  </div>
</div>

<!-- Modal Propietario -->
<div id="modal-propietario" class="modal-overlay">
  <div class="modal">
    <div class="modal-header">
      <h3 class="modal-title">ğŸ‘¤ Nuevo Propietario</h3>
      <button class="modal-close" onclick="closeModal('modal-propietario')">Ã—</button>
    </div>
    <div class="modal-body">
      <div class="form-group">
        <label class="form-label">Nombre *</label>
        <input type="text" id="propiet-nombre" class="form-input">
      </div>
      <div class="form-row">
        <div class="form-group">
          <label class="form-label">Email</label>
          <input type="email" id="propiet-email" class="form-input">
        </div>
        <div class="form-group">
          <label class="form-label">TelÃ©fono</label>
          <input type="tel" id="propiet-telefono" class="form-input">
        </div>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-secondary" onclick="closeModal('modal-propietario')">Cancelar</button>
      <button class="btn btn-primary" onclick="savePropietario()">Guardar</button>
    </div>
  </div>
</div>

<!-- Modal Empleado -->
<div id="modal-empleado" class="modal-overlay">
  <div class="modal">
    <div class="modal-header">
      <h3 class="modal-title">ğŸ‘¥ Nuevo Empleado</h3>
      <button class="modal-close" onclick="closeModal('modal-empleado')">Ã—</button>
    </div>
    <div class="modal-body">
      <div class="form-group">
        <label class="form-label">Nombre *</label>
        <input type="text" id="emp-nombre" class="form-input">
      </div>
      <div class="form-group">
        <label class="form-label">Email *</label>
        <input type="email" id="emp-email" class="form-input">
      </div>
      <div class="form-group">
        <label class="form-label">Rol</label>
        <select id="emp-rol" class="form-input">
          <option value="limpiador">Limpiador</option>
          <option value="supervisor">Supervisor</option>
          <option value="admin">Admin</option>
        </select>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-secondary" onclick="closeModal('modal-empleado')">Cancelar</button>
      <button class="btn btn-primary" onclick="saveEmpleado()">Guardar</button>
    </div>
  </div>
</div>

<!-- Modal Kit -->
<div id="modal-kit" class="modal-overlay">
  <div class="modal">
    <div class="modal-header">
      <h3 class="modal-title">ğŸ Nuevo Kit</h3>
      <button class="modal-close" onclick="closeModal('modal-kit')">Ã—</button>
    </div>
    <div class="modal-body">
      <div class="form-group">
        <label class="form-label">Nombre *</label>
        <input type="text" id="kit-nombre" class="form-input">
      </div>
      <div class="form-group">
        <label class="form-label">DescripciÃ³n</label>
        <input type="text" id="kit-desc" class="form-input">
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-secondary" onclick="closeModal('modal-kit')">Cancelar</button>
      <button class="btn btn-primary" onclick="saveKit()">Guardar</button>
    </div>
  </div>
</div>

<!-- Modal Extra -->
<div id="modal-extra" class="modal-overlay">
  <div class="modal">
    <div class="modal-header">
      <h3 class="modal-title">ğŸ§¹ Nuevo Extra</h3>
      <button class="modal-close" onclick="closeModal('modal-extra')">Ã—</button>
    </div>
    <div class="modal-body">
      <div class="form-row">
        <div class="form-group">
          <label class="form-label">Fecha *</label>
          <input type="date" id="extra-fecha" class="form-input">
        </div>
        <div class="form-group">
          <label class="form-label">Propiedad *</label>
          <select id="extra-prop" class="form-input"></select>
        </div>
      </div>
      <div class="form-group">
        <label class="form-label">Concepto *</label>
        <input type="text" id="extra-concepto" class="form-input">
      </div>
      <div class="form-group">
        <label class="form-label">Importe (â‚¬) *</label>
        <input type="number" id="extra-importe" class="form-input" step="0.01">
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-secondary" onclick="closeModal('modal-extra')">Cancelar</button>
      <button class="btn btn-primary" onclick="saveExtra()">Guardar</button>
    </div>
  </div>
</div>

<!-- Modal Mantenimiento -->
<div id="modal-mantenimiento" class="modal-overlay">
  <div class="modal">
    <div class="modal-header">
      <h3 class="modal-title">ğŸ”§ Nueva Incidencia</h3>
      <button class="modal-close" onclick="closeModal('modal-mantenimiento')">Ã—</button>
    </div>
    <div class="modal-body">
      <div class="form-row">
        <div class="form-group">
          <label class="form-label">Fecha</label>
          <input type="date" id="mant-fecha" class="form-input">
        </div>
        <div class="form-group">
          <label class="form-label">Propiedad *</label>
          <select id="mant-prop" class="form-input"></select>
        </div>
      </div>
      <div class="form-group">
        <label class="form-label">TÃ­tulo *</label>
        <input type="text" id="mant-titulo" class="form-input">
      </div>
      <div class="form-group">
        <label class="form-label">DescripciÃ³n</label>
        <textarea id="mant-desc" class="form-input" rows="2"></textarea>
      </div>
      <div class="form-row">
        <div class="form-group">
          <label class="form-label">Importe (â‚¬)</label>
          <input type="number" id="mant-importe" class="form-input" step="0.01" value="0">
        </div>
        <div class="form-group">
          <label class="form-label">Estado</label>
          <select id="mant-estado-sel" class="form-input">
            <option value="pendiente">Pendiente</option>
            <option value="resuelto">Resuelto</option>
          </select>
        </div>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-secondary" onclick="closeModal('modal-mantenimiento')">Cancelar</button>
      <button class="btn btn-primary" onclick="saveMantenimiento()">Guardar</button>
    </div>
  </div>
</div>

<!-- Modal Gasto -->
<div id="modal-gasto" class="modal-overlay">
  <div class="modal">
    <div class="modal-header">
      <h3 class="modal-title">ğŸ“‹ Nuevo Gasto Fijo</h3>
      <button class="modal-close" onclick="closeModal('modal-gasto')">Ã—</button>
    </div>
    <div class="modal-body">
      <div class="form-row">
        <div class="form-group">
          <label class="form-label">Fecha *</label>
          <input type="date" id="gasto-fecha" class="form-input">
        </div>
        <div class="form-group">
          <label class="form-label">Propiedad *</label>
          <select id="gasto-prop" class="form-input"></select>
        </div>
      </div>
      <div class="form-row">
        <div class="form-group">
          <label class="form-label">Tipo *</label>
          <select id="gasto-tipo" class="form-input">
            <option value="luz">ğŸ’¡ Luz</option>
            <option value="agua">ğŸ’§ Agua</option>
            <option value="gas">ğŸ”¥ Gas</option>
            <option value="comunidad">ğŸ¢ Comunidad</option>
            <option value="internet">ğŸ“¶ Internet</option>
            <option value="otro">ğŸ“ Otro</option>
          </select>
        </div>
        <div class="form-group">
          <label class="form-label">Importe (â‚¬) *</label>
          <input type="number" id="gasto-importe" class="form-input" step="0.01">
        </div>
      </div>
      <div class="form-group">
        <label class="form-label">Concepto</label>
        <input type="text" id="gasto-concepto" class="form-input">
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-secondary" onclick="closeModal('modal-gasto')">Cancelar</button>
      <button class="btn btn-primary" onclick="saveGasto()">Guardar</button>
    </div>
  </div>
</div>

<!-- Modal IntegraciÃ³n -->
<div id="modal-integracion" class="modal-overlay">
  <div class="modal">
    <div class="modal-header">
      <h3 class="modal-title" id="integ-modal-title">ğŸ”— Conectar Plataforma</h3>
      <button class="modal-close" onclick="closeModal('modal-integracion')">Ã—</button>
    </div>
    <div class="modal-body">
      <input type="hidden" id="integ-plataforma">
      <input type="hidden" id="integ-edit-id">
      
      <div id="integ-info" style="background:var(--accent-bg); padding:14px; border-radius:var(--radius-sm); margin-bottom:18px; font-size:0.85rem;">
        <strong>â„¹ï¸ InformaciÃ³n</strong>
        <p id="integ-help-text" style="margin-top:6px; color:var(--text-secondary);"></p>
      </div>
      
      <div class="form-group">
        <label class="form-label">Nombre de la cuenta *</label>
        <input type="text" id="integ-nombre" class="form-input" placeholder="Ej: Avaibook Principal, Cuenta Canarias...">
        <small style="color:var(--text-muted); font-size:0.75rem;">Identifica esta cuenta si tienes varias del mismo PMS</small>
      </div>
      
      <!-- Avaibook / Icnea / General -->
      <div id="integ-fields-apikey" class="form-group">
        <label class="form-label">API Key *</label>
        <input type="text" id="integ-apikey" class="form-input" placeholder="Tu API Key">
      </div>
      
      <div id="integ-fields-userid" class="form-group" style="display:none;">
        <label class="form-label">User ID / Owner ID</label>
        <input type="text" id="integ-userid" class="form-input" placeholder="ID de usuario en la plataforma">
      </div>
      
      <div id="integ-fields-secret" class="form-group" style="display:none;">
        <label class="form-label">API Secret</label>
        <input type="text" id="integ-secret" class="form-input" placeholder="Secret (si aplica)">
      </div>
      
      <div class="form-group">
        <label class="form-label">SincronizaciÃ³n automÃ¡tica</label>
        <select id="integ-interval" class="form-input">
          <option value="60">Cada hora</option>
          <option value="120">Cada 2 horas</option>
          <option value="360">Cada 6 horas</option>
          <option value="720">Cada 12 horas</option>
          <option value="1440">Diariamente</option>
        </select>
      </div>
      
      <label style="display:flex; align-items:center; gap:10px; margin-top:14px; cursor:pointer;">
        <input type="checkbox" id="integ-activo" checked> IntegraciÃ³n activa
      </label>
    </div>
    <div class="modal-footer">
      <button class="btn btn-danger" id="integ-btn-delete" onclick="deleteIntegracion()" style="display:none; margin-right:auto;">Eliminar</button>
      <button class="btn btn-secondary" onclick="closeModal('modal-integracion')">Cancelar</button>
      <button class="btn btn-primary" onclick="saveIntegracion()">ğŸ’¾ Guardar y Conectar</button>
    </div>
  </div>
</div>

<!-- Modal Mapear Propiedad -->
<div id="modal-mapear-prop" class="modal-overlay">
  <div class="modal">
    <div class="modal-header">
      <h3 class="modal-title">ğŸ  Configurar Propiedad</h3>
      <button class="modal-close" onclick="closeModal('modal-mapear-prop')">Ã—</button>
    </div>
    <div class="modal-body">
      <input type="hidden" id="map-prop-id">
      <div class="form-group">
        <label class="form-label">Nombre interno *</label>
        <input type="text" id="map-prop-nombre" class="form-input" placeholder="Nombre que usarÃ¡s en CleanManager">
      </div>
      <div class="form-row">
        <div class="form-group">
          <label class="form-label">Habitaciones</label>
          <input type="number" id="map-prop-rooms" class="form-input" value="1">
        </div>
        <div class="form-group">
          <label class="form-label">BaÃ±os</label>
          <input type="number" id="map-prop-baths" class="form-input" value="1">
        </div>
      </div>
      <div class="form-row">
        <div class="form-group">
          <label class="form-label">Camas Dobles</label>
          <input type="number" id="map-prop-camas-dobles" class="form-input" value="0">
        </div>
        <div class="form-group">
          <label class="form-label">Camas Individuales</label>
          <input type="number" id="map-prop-camas-ind" class="form-input" value="0">
        </div>
      </div>
      <div class="form-row">
        <div class="form-group">
          <label class="form-label">Precio Limpieza (â‚¬)</label>
          <input type="number" id="map-prop-precio" class="form-input" value="45" step="0.01">
        </div>
        <div class="form-group">
          <label class="form-label">DuraciÃ³n (min)</label>
          <input type="number" id="map-prop-duracion" class="form-input" value="90">
        </div>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-secondary" onclick="closeModal('modal-mapear-prop')">Cancelar</button>
      <button class="btn btn-primary" onclick="savePropMapping()">Guardar</button>
    </div>
  </div>
</div>

<!-- Toast -->
<div id="toast" class="toast"><span id="toast-icon">âœ“</span><span id="toast-msg">OK</span></div>

<script>
// ===== CONFIG =====
const API = 'https://chat.adrian-261.workers.dev';
const TBL = {
  usuarios: 'cm_usuarios',
  servicios: 'cm_servicios',
  reservas: 'cm_reservas',
  credenciales: 'cm_credenciales',
  propertyMapping: 'cm_property_mapping',
  inventario: 'inventario',
  kits: 'kits',
  propietarios: 'propietarios',
  gastos: 'gastos_fijos',
  mantenimiento: 'mantenimiento',
  extras: 'limpieza_extras',
  propiedades: 'propiedades_config',
  empleados: 'empleados',
  alertas: 'alertas_config'
};

// InformaciÃ³n de plataformas
const PLATFORMS = {
  avaibook: { name: 'Avaibook', fields: ['apikey', 'userid'], help: 'ObtÃ©n tu API Key desde el panel de Avaibook en ConfiguraciÃ³n â†’ API' },
  icnea: { name: 'Icnea', fields: ['apikey', 'userid'], help: 'Tu API Key e ID de propietario los encuentras en Icnea â†’ ConfiguraciÃ³n â†’ API' },
  hostify: { name: 'Hostify', fields: ['apikey', 'secret'], help: 'Genera tu API Key desde Hostify â†’ Settings â†’ API' },
  guesty: { name: 'Guesty', fields: ['apikey', 'secret'], help: 'Accede a tu API Key en Guesty â†’ Marketplace â†’ API' },
  smoobu: { name: 'Smoobu', fields: ['apikey'], help: 'Encuentra tu API Key en Smoobu â†’ ConfiguraciÃ³n â†’ API' },
  lodgify: { name: 'Lodgify', fields: ['apikey'], help: 'Tu API Key estÃ¡ en Lodgify â†’ ConfiguraciÃ³n â†’ Integraciones â†’ API' }
};

// ===== STATE =====
const S = {
  user: null,
  clienteEmail: null,
  servicios: [],
  inventario: [],
  kits: [],
  propietarios: [],
  gastos: [],
  mantenimiento: [],
  extras: [],
  propiedades: [],
  empleados: [],
  alertas: null,
  reservas: [],
  credenciales: [],
  propertyMappings: []
};

// ===== INIT =====
document.addEventListener('DOMContentLoaded', () => {
  const saved = localStorage.getItem('cm_user');
  if (saved) {
    S.user = JSON.parse(saved);
    S.clienteEmail = S.user.cliente_email;
    initApp();
  } else {
    showLogin();
  }
});

function showLogin() {
  hide('loading-overlay');
  show('login-view');
  hide('app-view');
}

async function initApp() {
  show('loading-overlay');
  hide('login-view');
  try {
    await loadAll();
    hide('loading-overlay');
    show('app-view');
    
    $('#account-name').textContent = S.user.empresa || S.clienteEmail;
    $('#user-name').textContent = S.user.nombre || 'Usuario';
    $('#user-avatar').textContent = (S.user.nombre || 'U').substring(0, 2).toUpperCase();
    
    initFilters();
    renderDashboard();
  } catch (e) {
    console.error(e);
    toast('Error al cargar', 'error');
    hide('loading-overlay');
    show('app-view');
  }
}

async function loadAll() {
  const ce = encodeURIComponent(S.clienteEmail);
  const load = async (t, f = 'cliente_email') => {
    try {
      const r = await fetch(`${API}/supa/list/${t}?${f}=eq.${ce}`);
      return r.ok ? await r.json() : [];
    } catch { return []; }
  };
  
  [S.servicios, S.inventario, S.kits, S.propietarios, S.gastos, S.mantenimiento, S.extras, S.propiedades, S.empleados, S.reservas, S.credenciales, S.propertyMappings] = await Promise.all([
    load(TBL.servicios),
    load(TBL.inventario),
    load(TBL.kits),
    load(TBL.propietarios),
    load(TBL.gastos),
    load(TBL.mantenimiento),
    load(TBL.extras),
    load(TBL.propiedades),
    load(TBL.empleados, 'email_host'),
    load(TBL.reservas),
    load(TBL.credenciales),
    load(TBL.propertyMapping)
  ]);
  
  const alertas = await load(TBL.alertas);
  S.alertas = alertas[0] || null;
}

// ===== AUTH =====
function switchAuthTab(tab) {
  $$('.login-tab').forEach(t => t.classList.remove('active'));
  event.target.classList.add('active');
  $('#form-login').style.display = tab === 'login' ? 'block' : 'none';
  $('#form-register').style.display = tab === 'register' ? 'block' : 'none';
  $('#auth-error').style.display = 'none';
}

async function doLogin() {
  const email = $('#login-email').value.trim().toLowerCase();
  const pass = $('#login-password').value;
  if (!email || !pass) return showAuthError('Completa todos los campos');
  
  try {
    const r = await fetch(`${API}/supa/list/${TBL.usuarios}?email=eq.${encodeURIComponent(email)}`);
    const users = await r.json();
    if (!users.length) return showAuthError('Usuario no encontrado');
    
    const user = users[0];
    if (user.password_hash !== pass) return showAuthError('ContraseÃ±a incorrecta');
    if (!user.activo) return showAuthError('Cuenta desactivada');
    
    S.user = user;
    S.clienteEmail = user.cliente_email;
    localStorage.setItem('cm_user', JSON.stringify(user));
    
    // Update last login
    fetch(`${API}/supa/patch/${TBL.usuarios}?id=eq.${user.id}`, {
      method: 'PATCH',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ last_login: new Date().toISOString() })
    });
    
    await initApp();
  } catch (e) {
    showAuthError('Error de conexiÃ³n');
  }
}

async function doRegister() {
  const empresa = $('#reg-empresa').value.trim();
  const nombre = $('#reg-nombre').value.trim();
  const email = $('#reg-email').value.trim().toLowerCase();
  const telefono = $('#reg-telefono').value.trim();
  const pass = $('#reg-password').value;
  
  if (!empresa || !nombre || !email || !pass) return showAuthError('Completa todos los campos');
  if (pass.length < 6) return showAuthError('ContraseÃ±a mÃ­nimo 6 caracteres');
  if (!email.includes('@')) return showAuthError('Email no vÃ¡lido');
  
  try {
    // Check existing
    console.log('Checking if email exists...');
    const check = await fetch(`${API}/supa/list/${TBL.usuarios}?email=eq.${encodeURIComponent(email)}`);
    const checkData = await check.json();
    console.log('Check response:', checkData);
    if (checkData.length) return showAuthError('Este email ya estÃ¡ registrado');
    
    // Create user
    const data = {
      email,
      password_hash: pass,
      nombre,
      empresa,
      telefono,
      cliente_email: email,
      rol: 'admin',
      activo: true,
      plan: 'trial'
    };
    
    console.log('Creating user with data:', data);
    const r = await fetch(`${API}/supa/create/${TBL.usuarios}`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(data)
    });
    
    console.log('Create response status:', r.status);
    const responseText = await r.text();
    console.log('Create response body:', responseText);
    
    let users;
    try {
      users = JSON.parse(responseText);
    } catch (e) {
      return showAuthError('Error del servidor: ' + responseText.substring(0, 100));
    }
    
    if (!r.ok) {
      return showAuthError('Error: ' + (users.message || users.error || JSON.stringify(users)));
    }
    
    if (!users || !users.length) {
      return showAuthError('No se pudo crear el usuario');
    }
    
    S.user = users[0];
    S.clienteEmail = email;
    localStorage.setItem('cm_user', JSON.stringify(S.user));
    
    toast('Â¡Cuenta creada!');
    await initApp();
  } catch (e) {
    console.error('Register error:', e);
    showAuthError('Error: ' + e.message);
  }
}

function showAuthError(msg) {
  const el = $('#auth-error');
  el.textContent = msg;
  el.style.display = 'block';
}

function logout() {
  if (confirm('Â¿Cerrar sesiÃ³n?')) {
    localStorage.removeItem('cm_user');
    location.reload();
  }
}

// ===== NAVIGATION =====
function navigate(view) {
  $$('.nav-item').forEach(n => n.classList.remove('active'));
  $(`.nav-item[data-view="${view}"]`)?.classList.add('active');
  $$('.view').forEach(v => v.classList.remove('active'));
  $(`#view-${view}`)?.classList.add('active');
  
  const titles = { dashboard:'Dashboard', servicios:'Servicios', reservas:'Reservas', stock:'Inventario', kits:'Kits', propiedades:'Propiedades', propietarios:'Propietarios', empleados:'Empleados', extras:'Extras', mantenimiento:'Mantenimiento', gastos:'Gastos Fijos', alertas:'Alertas', integraciones:'Integraciones' };
  $('#page-title').textContent = titles[view] || '';
  
  renderView(view);
  closeSidebar();
}

function renderView(v) {
  const renders = { dashboard:renderDashboard, servicios:renderServicios, reservas:renderReservas, stock:renderStock, kits:renderKits, propiedades:renderPropiedades, propietarios:renderPropietarios, empleados:renderEmpleados, extras:renderExtras, mantenimiento:renderMantenimiento, gastos:renderGastos, alertas:renderAlertas, integraciones:renderIntegraciones };
  renders[v]?.();
}

function toggleSidebar() {
  $('#sidebar').classList.toggle('open');
  $('#mobile-overlay').classList.toggle('open');
}
function closeSidebar() {
  $('#sidebar').classList.remove('open');
  $('#mobile-overlay').classList.remove('open');
}

// ===== RENDERS =====
function renderDashboard() {
  const hoy = new Date().toISOString().split('T')[0];
  const servHoy = S.servicios.filter(s => s.fecha_servicio === hoy);
  const pendientes = S.servicios.filter(s => s.estado === 'pendiente' || s.estado === 'confirmado');
  const stockBajo = S.inventario.filter(i => i.stock < i.stock_minimo);
  
  $('#stat-hoy').textContent = servHoy.length;
  $('#stat-pendientes').textContent = pendientes.length;
  $('#stat-props').textContent = S.propiedades.length;
  $('#stat-stock-bajo').textContent = stockBajo.length;
  
  // Badge
  if (pendientes.length) {
    $('#servicios-badge').style.display = 'inline';
    $('#servicios-badge').textContent = pendientes.length;
  } else {
    $('#servicios-badge').style.display = 'none';
  }
  
  if (stockBajo.length) {
    $('#stock-alert-badge').style.display = 'inline';
    $('#stock-alert-badge').textContent = stockBajo.length;
  } else {
    $('#stock-alert-badge').style.display = 'none';
  }
  
  // PrÃ³ximos servicios
  const proximos = S.servicios.filter(s => s.fecha_servicio >= hoy && s.estado !== 'completado' && s.estado !== 'cancelado').sort((a,b) => a.fecha_servicio.localeCompare(b.fecha_servicio)).slice(0, 5);
  
  $('#dash-servicios').innerHTML = proximos.length ? proximos.map(s => `
    <div style="display:flex; justify-content:space-between; align-items:center; padding:10px 0; border-bottom:1px solid var(--border);">
      <div>
        <div style="font-weight:600;">${s.propiedad_nombre}</div>
        <div style="font-size:0.8rem; color:var(--text-muted);">${formatDate(s.fecha_servicio)} ${s.hora_inicio || ''}</div>
      </div>
      <span class="badge ${estadoBadge(s.estado)}">${s.estado}</span>
    </div>
  `).join('') : '<p style="color:var(--text-muted); text-align:center; padding:20px;">Sin servicios prÃ³ximos</p>';
  
  // Alertas
  let alertas = [];
  if (stockBajo.length) alertas.push(`âš ï¸ ${stockBajo.length} artÃ­culos con stock bajo`);
  const mantPend = S.mantenimiento.filter(m => m.estado === 'pendiente');
  if (mantPend.length) alertas.push(`ğŸ”§ ${mantPend.length} incidencias pendientes`);
  
  $('#dash-alertas').innerHTML = alertas.length ? alertas.map(a => `<div style="padding:10px 0; border-bottom:1px solid var(--border);">${a}</div>`).join('') : '<p style="color:var(--text-muted); text-align:center; padding:20px;">âœ“ Todo en orden</p>';
}

function renderServicios() {
  const fecha = $('#serv-fecha').value;
  const estado = $('#serv-estado').value;
  const prop = $('#serv-propiedad').value;
  
  let list = S.servicios;
  if (fecha) list = list.filter(s => s.fecha_servicio === fecha);
  if (estado) list = list.filter(s => s.estado === estado);
  if (prop) list = list.filter(s => s.propiedad_nombre === prop);
  
  list.sort((a, b) => b.fecha_servicio.localeCompare(a.fecha_servicio));
  
  $('#servicios-tbody').innerHTML = list.length ? list.map(s => `
    <tr>
      <td>${formatDate(s.fecha_servicio)}</td>
      <td>${s.hora_inicio || '-'}</td>
      <td><strong>${s.propiedad_nombre}</strong></td>
      <td><span class="badge badge-neutral">${s.tipo_servicio || 'checkout'}</span></td>
      <td>${s.huesped_nombre || '-'}</td>
      <td>${s.empleado_nombre || '<span style="color:var(--text-muted)">Sin asignar</span>'}</td>
      <td><span class="badge ${estadoBadge(s.estado)}">${s.estado}</span></td>
      <td>
        <button class="btn btn-sm btn-secondary" onclick="editServicio(${s.id})">âœï¸</button>
        ${s.estado !== 'completado' ? `<button class="btn btn-sm btn-success" onclick="completarServicio(${s.id})">âœ“</button>` : ''}
      </td>
    </tr>
  `).join('') : '<tr><td colspan="8" style="text-align:center; padding:30px; color:var(--text-muted);">Sin servicios</td></tr>';
}

function renderReservas() {
  const tbody = $('#reservas-tbody');
  const emptyEl = $('#reservas-empty');
  
  // Filtros
  const desde = $('#res-desde').value;
  const hasta = $('#res-hasta').value;
  const origen = $('#res-origen').value;
  const status = $('#res-status').value;
  
  let filtered = [...S.reservas];
  
  if (desde) filtered = filtered.filter(r => r.check_in >= desde);
  if (hasta) filtered = filtered.filter(r => r.check_in <= hasta);
  if (origen) filtered = filtered.filter(r => r.origen === origen);
  if (status) filtered = filtered.filter(r => r.status === status);
  
  // Ordenar por check_in
  filtered.sort((a, b) => new Date(a.check_in) - new Date(b.check_in));
  
  if (!filtered.length) {
    tbody.innerHTML = '';
    emptyEl.style.display = 'block';
    return;
  }
  
  emptyEl.style.display = 'none';
  
  const statusBadge = (s) => {
    if (s === 'confirmed') return 'badge-success';
    if (s === 'cancelled') return 'badge-danger';
    return 'badge-warning';
  };
  
  const statusText = (s) => {
    if (s === 'confirmed') return 'âœ… Confirmada';
    if (s === 'cancelled') return 'âŒ Cancelada';
    return 'â³ Pendiente';
  };
  
  const canalIcon = (origen, partner) => {
    if (partner?.toLowerCase().includes('airbnb')) return 'ğŸ  Airbnb';
    if (partner?.toLowerCase().includes('booking')) return 'ğŸ…±ï¸ Booking';
    if (origen === 'avaibook') return 'ğŸ“— Avaibook';
    if (origen === 'icnea') return 'ğŸ“˜ Icnea';
    return partner || origen || 'Directo';
  };
  
  tbody.innerHTML = filtered.map(r => `
    <tr>
      <td><strong>${formatDate(r.check_in)}</strong></td>
      <td>${formatDate(r.check_out)}</td>
      <td>${r.propiedad_nombre || '<span style="color:var(--text-muted)">Sin asignar</span>'}</td>
      <td>
        <div>${r.huesped_nombre || 'HuÃ©sped'}</div>
        <small style="color:var(--text-muted)">${r.huesped_email || ''}</small>
      </td>
      <td>${r.num_huespedes || '-'} (${r.num_adultos || 0}A/${r.num_ninos || 0}N)</td>
      <td>${canalIcon(r.origen, r.partner_name)}</td>
      <td><span class="badge ${statusBadge(r.status)}">${statusText(r.status)}</span></td>
      <td><strong>${r.precio ? r.precio.toFixed(2) + 'â‚¬' : '-'}</strong></td>
    </tr>
  `).join('');
}

async function syncAllReservas() {
  toast('Sincronizando reservas de todos los PMS...');
  
  const plataformas = [...new Set(S.credenciales.filter(c => c.activo).map(c => c.plataforma))];
  
  for (const plataforma of plataformas) {
    await syncReservas(plataforma);
  }
  
  await loadAll();
  renderReservas();
  toast('âœ… SincronizaciÃ³n completada');
}

function renderStock() {
  const bajo = S.inventario.filter(i => i.stock < i.stock_minimo);
  const ok = S.inventario.filter(i => i.stock >= i.stock_minimo);
  // TODO: calcular "se agotarÃ¡n" basado en reservas futuras
  const agotaran = 0;
  const reservasFuturas = S.reservas?.length || 0;
  
  $('#stat-bajo-min').textContent = bajo.length;
  $('#stat-agotaran').textContent = agotaran;
  $('#stat-ok').textContent = ok.length;
  $('#stat-reservas-futuras').textContent = reservasFuturas;
  
  const formatMoney = n => n.toLocaleString('es-ES', { minimumFractionDigits: 2, maximumFractionDigits: 2 }) + ' â‚¬';
  
  $('#stock-grid').innerHTML = S.inventario.length ? S.inventario.map(i => {
    const isCritical = i.stock < i.stock_minimo;
    const isLow = i.stock < i.stock_minimo * 1.5 && !isCritical;
    
    let statusClass = 'ok', forecastHtml = '';
    if (isCritical) {
      statusClass = 'critical';
      forecastHtml = `<div class="stock-forecast critical">âš ï¸ Bajo mÃ­nimo (${i.stock_minimo})</div>`;
    } else {
      forecastHtml = `<div class="stock-forecast ok">âœ… Stock OK</div>`;
    }
    
    const cardClass = isCritical ? 'critical' : (isLow ? 'warning' : '');
    const pagadoBadge = i.pagado_por === 'propietario' 
      ? '<span class="stock-badge prop">ğŸ‘¤ Prop</span>' 
      : '<span class="stock-badge gest">ğŸ¢ Gest</span>';
    
    return `<div class="stock-card-new ${cardClass}" onclick="editStock(${i.id})">
      <div class="stock-card-top">
        <div class="stock-item-title">${i.item}</div>
        <div class="stock-badges">
          <span class="stock-badge min">Min: ${i.stock_minimo}</span>
          ${i.precio_unidad ? `<span class="stock-badge price">${formatMoney(i.precio_unidad)}</span>` : ''}
          ${pagadoBadge}
        </div>
      </div>
      ${forecastHtml}
      <div class="stock-stat">
        <div class="stock-val ${statusClass}">${i.stock}</div>
        <div class="stock-label">UNIDADES</div>
      </div>
      <div class="stock-actions-new">
        <button class="stock-btn-new neg" onclick="event.stopPropagation(); adjStock(${i.id}, -1)">â–</button>
        <button class="stock-btn-new" onclick="event.stopPropagation(); adjStock(${i.id}, 1)">â•</button>
        <button class="stock-btn-new" onclick="event.stopPropagation(); editStock(${i.id})">âœï¸</button>
      </div>
    </div>`;
  }).join('') : empty('ğŸ“¦', 'Sin artÃ­culos. Â¡Crea el primero!');
}

function renderKits() {
  $('#kits-grid').innerHTML = S.kits.length ? S.kits.map(k => `
    <div class="item-card">
      <div class="item-card-title">${k.nombre}</div>
      <div class="item-card-meta">${k.descripcion || ''}</div>
    </div>
  `).join('') : empty('ğŸ', 'Sin kits');
}

function renderPropiedades() {
  $('#propiedades-grid').innerHTML = S.propiedades.length ? S.propiedades.map(p => `
    <div class="item-card">
      <div class="item-card-header">
        <div class="item-card-title">${p.propiedad_nombre}</div>
        <span class="badge badge-neutral">${p.precio_limpieza || 0}â‚¬</span>
      </div>
    </div>
  `).join('') : empty('ğŸ ', 'Sin propiedades');
}

function renderPropietarios() {
  $('#propietarios-grid').innerHTML = S.propietarios.length ? S.propietarios.map(p => `
    <div class="item-card">
      <div class="item-card-title">${p.nombre}</div>
      <div class="item-card-meta">${p.email || ''}<br>${p.telefono || ''}</div>
    </div>
  `).join('') : empty('ğŸ‘¤', 'Sin propietarios');
}

function renderEmpleados() {
  $('#empleados-grid').innerHTML = S.empleados.length ? S.empleados.map(e => `
    <div class="item-card">
      <div class="item-card-header">
        <div class="item-card-title">${e.nombre}</div>
        <span class="badge ${e.activo ? 'badge-success' : 'badge-neutral'}">${e.activo ? 'Activo' : 'Inactivo'}</span>
      </div>
      <div class="item-card-meta">${e.email || ''}</div>
    </div>
  `).join('') : empty('ğŸ‘¥', 'Sin empleados');
}

function renderExtras() {
  const mes = $('#extras-mes').value;
  let list = S.extras;
  if (mes) list = list.filter(e => e.fecha?.startsWith(mes));
  
  $('#extras-tbody').innerHTML = list.length ? list.map(e => `
    <tr>
      <td>${formatDate(e.fecha)}</td>
      <td>${e.propiedad_nombre || ''}</td>
      <td>${e.concepto || ''}</td>
      <td><strong>${(e.importe || 0).toFixed(2)}â‚¬</strong></td>
      <td><button class="btn btn-sm btn-danger" onclick="delExtra(${e.id})">ğŸ—‘</button></td>
    </tr>
  `).join('') : '<tr><td colspan="5" style="text-align:center; padding:30px; color:var(--text-muted);">Sin extras</td></tr>';
}

function renderMantenimiento() {
  const estado = $('#mant-estado').value;
  let list = S.mantenimiento;
  if (estado) list = list.filter(m => m.estado === estado);
  
  $('#mantenimiento-grid').innerHTML = list.length ? list.map(m => `
    <div class="item-card">
      <div class="item-card-header">
        <div class="item-card-title">${m.titulo}</div>
        <span class="badge ${m.estado === 'resuelto' ? 'badge-success' : 'badge-warning'}">${m.estado}</span>
      </div>
      <div class="item-card-meta">${m.propiedad_nombre || ''} Â· ${formatDate(m.fecha)}</div>
      ${m.importe ? `<div style="margin-top:8px; font-weight:700;">${m.importe.toFixed(2)}â‚¬</div>` : ''}
    </div>
  `).join('') : empty('ğŸ”§', 'Sin incidencias');
}

function renderGastos() {
  const mes = $('#gastos-mes').value;
  const tipo = $('#gastos-tipo').value;
  let list = S.gastos;
  if (mes) list = list.filter(g => g.fecha?.startsWith(mes));
  if (tipo) list = list.filter(g => g.tipo === tipo);
  
  const icons = { luz:'ğŸ’¡', agua:'ğŸ’§', gas:'ğŸ”¥', comunidad:'ğŸ¢', internet:'ğŸ“¶', otro:'ğŸ“' };
  
  $('#gastos-tbody').innerHTML = list.length ? list.map(g => `
    <tr>
      <td>${formatDate(g.fecha)}</td>
      <td>${g.propiedad_nombre || ''}</td>
      <td>${icons[g.tipo] || ''} ${g.tipo || ''}</td>
      <td>${g.concepto || ''}</td>
      <td><strong>${(g.importe || 0).toFixed(2)}â‚¬</strong></td>
      <td>${g.pagado_por || 'gestor'}</td>
      <td><button class="btn btn-sm btn-danger" onclick="delGasto(${g.id})">ğŸ—‘</button></td>
    </tr>
  `).join('') : '<tr><td colspan="7" style="text-align:center; padding:30px; color:var(--text-muted);">Sin gastos</td></tr>';
}

function renderAlertas() {
  const a = S.alertas || {};
  $('#alert-whatsapp').value = a.whatsapp_notificaciones || '';
  $('#alert-email').value = a.email_notificaciones || '';
  $('#alert-stock').checked = a.alerta_stock_bajo || false;
  $('#alert-semanal').checked = a.recordatorio_semanal || false;
}

// ===== SAVES =====
async function saveServicio() {
  const editId = $('#serv-edit-id').value;
  const propSel = $('#serv-propiedad-sel');
  const empSel = $('#serv-empleado');
  const empOpt = empSel.options[empSel.selectedIndex];
  
  const data = {
    cliente_email: S.clienteEmail,
    propiedad_nombre: propSel.value,
    tipo_servicio: $('#serv-tipo').value,
    fecha_servicio: $('#serv-fecha-input').value,
    hora_inicio: $('#serv-hora').value || null,
    check_in: $('#serv-checkin').value || null,
    check_out: $('#serv-checkout').value || null,
    huesped_nombre: $('#serv-huesped').value.trim() || null,
    num_huespedes: parseInt($('#serv-num-huespedes').value) || 2,
    empleado_id: empSel.value || null,
    empleado_nombre: empOpt?.text !== 'Sin asignar' ? empOpt?.text : null,
    precio: parseFloat($('#serv-precio').value) || null,
    estado: $('#serv-estado-sel').value,
    prioridad: $('#serv-prioridad').value,
    notas: $('#serv-notas').value.trim() || null
  };
  
  if (!data.propiedad_nombre || !data.fecha_servicio) return toast('Propiedad y fecha son obligatorios', 'error');
  
  closeModal('modal-servicio');
  
  try {
    if (editId) {
      await fetch(`${API}/supa/patch/${TBL.servicios}?id=eq.${editId}`, {
        method: 'PATCH',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(data)
      });
    } else {
      await fetch(`${API}/supa/create/${TBL.servicios}`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(data)
      });
    }
    await loadAll();
    renderServicios();
    renderDashboard();
    toast(editId ? 'Servicio actualizado' : 'Servicio creado');
  } catch (e) { toast('Error', 'error'); }
}

// === STOCK FUNCTIONS ===
function openStockModal(item = null) {
  // Reset form
  $('#stock-edit-id').value = '';
  $('#stock-item').value = '';
  $('#stock-qty').value = '0';
  $('#stock-min').value = '10';
  $('#stock-precio').value = '0';
  $('#stock-pagador').value = 'gestor';
  $('#stock-c-limp').value = '0';
  $('#stock-c-hab').value = '0';
  $('#stock-c-bano').value = '0';
  $('#stock-c-cama-doble').value = '0';
  $('#stock-c-cama-indiv').value = '0';
  $('#stock-c-adulto').value = '0';
  $('#stock-c-nino').value = '0';
  $('#stock-c-bebe').value = '0';
  $('#stock-c-huesp').value = '0';
  
  if (item) {
    $('#stock-modal-title').textContent = 'âœï¸ Editar ArtÃ­culo';
    $('#stock-edit-id').value = item.id;
    $('#stock-item').value = item.item || '';
    $('#stock-qty').value = item.stock || 0;
    $('#stock-min').value = item.stock_minimo || 10;
    $('#stock-precio').value = item.precio_unidad || 0;
    $('#stock-pagador').value = item.pagado_por || 'gestor';
    $('#stock-c-limp').value = item.consumo_por_limpieza || 0;
    $('#stock-c-hab').value = item.consumo_habitacion || 0;
    $('#stock-c-bano').value = item.consumo_bano || 0;
    $('#stock-c-cama-doble').value = item.consumo_cama_doble || 0;
    $('#stock-c-cama-indiv').value = item.consumo_cama_indiv || 0;
    $('#stock-c-adulto').value = item.consumo_adulto || 0;
    $('#stock-c-nino').value = item.consumo_nino || 0;
    $('#stock-c-bebe').value = item.consumo_bebe || 0;
    $('#stock-c-huesp').value = item.consumo_huesped || 0;
    $('#stock-btn-delete').style.display = 'block';
  } else {
    $('#stock-modal-title').textContent = 'ğŸ“¦ Nuevo ArtÃ­culo';
    $('#stock-btn-delete').style.display = 'none';
  }
  
  openModal('modal-stock');
}

function editStock(id) {
  const item = S.inventario.find(i => i.id === id);
  if (item) openStockModal(item);
}

async function saveStock() {
  const editId = $('#stock-edit-id').value;
  const data = {
    cliente_email: S.clienteEmail,
    item: $('#stock-item').value.trim(),
    stock: parseInt($('#stock-qty').value) || 0,
    stock_minimo: parseInt($('#stock-min').value) || 10,
    precio_unidad: parseFloat($('#stock-precio').value) || 0,
    pagado_por: $('#stock-pagador').value,
    consumo_por_limpieza: parseInt($('#stock-c-limp').value) || 0,
    consumo_habitacion: parseInt($('#stock-c-hab').value) || 0,
    consumo_bano: parseInt($('#stock-c-bano').value) || 0,
    consumo_cama_doble: parseInt($('#stock-c-cama-doble').value) || 0,
    consumo_cama_indiv: parseInt($('#stock-c-cama-indiv').value) || 0,
    consumo_adulto: parseInt($('#stock-c-adulto').value) || 0,
    consumo_nino: parseInt($('#stock-c-nino').value) || 0,
    consumo_bebe: parseInt($('#stock-c-bebe').value) || 0,
    consumo_huesped: parseInt($('#stock-c-huesp').value) || 0
  };
  if (!data.item) return toast('Nombre obligatorio', 'error');
  
  closeModal('modal-stock');
  
  try {
    if (editId) {
      // Update existing
      await fetch(`${API}/supa/patch/${TBL.inventario}?id=eq.${editId}`, {
        method: 'PATCH',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(data)
      });
      toast('âœ… ArtÃ­culo actualizado');
    } else {
      // Create new
      await create(TBL.inventario, data);
      toast('âœ… ArtÃ­culo creado');
    }
    await loadAll();
    renderStock();
    renderDashboard();
  } catch (e) {
    console.error(e);
    toast('Error al guardar', 'error');
  }
}

async function deleteStock() {
  const editId = $('#stock-edit-id').value;
  if (!editId) return;
  
  if (!confirm('Â¿Eliminar este artÃ­culo del inventario?')) return;
  
  closeModal('modal-stock');
  
  try {
    await fetch(`${API}/supa/delete/${TBL.inventario}?id=eq.${editId}`, { method: 'DELETE' });
    await loadAll();
    renderStock();
    renderDashboard();
    toast('ğŸ—‘ï¸ ArtÃ­culo eliminado');
  } catch (e) {
    console.error(e);
    toast('Error al eliminar', 'error');
  }
}

async function savePropiedad() {
  const data = {
    cliente_email: S.clienteEmail,
    propiedad_nombre: $('#prop-nombre').value.trim(),
    precio_limpieza: parseFloat($('#prop-precio').value) || 0
  };
  if (!data.propiedad_nombre) return toast('Nombre obligatorio', 'error');
  
  closeModal('modal-propiedad');
  await create(TBL.propiedades, data);
  await loadAll();
  renderPropiedades();
  renderDashboard();
  initFilters();
  toast('Propiedad creada');
}

async function savePropietario() {
  const data = {
    cliente_email: S.clienteEmail,
    nombre: $('#propiet-nombre').value.trim(),
    email: $('#propiet-email').value.trim(),
    telefono: $('#propiet-telefono').value.trim()
  };
  if (!data.nombre) return toast('Nombre obligatorio', 'error');
  
  closeModal('modal-propietario');
  await create(TBL.propietarios, data);
  await loadAll();
  renderPropietarios();
  toast('Propietario creado');
}

async function saveEmpleado() {
  const data = {
    email_host: S.clienteEmail,
    nombre: $('#emp-nombre').value.trim(),
    email: $('#emp-email').value.trim(),
    rol: $('#emp-rol').value,
    activo: true
  };
  if (!data.nombre || !data.email) return toast('Nombre y email obligatorios', 'error');
  
  closeModal('modal-empleado');
  await create(TBL.empleados, data);
  await loadAll();
  renderEmpleados();
  initFilters();
  toast('Empleado creado');
}

async function saveKit() {
  const data = {
    cliente_email: S.clienteEmail,
    nombre: $('#kit-nombre').value.trim(),
    descripcion: $('#kit-desc').value.trim()
  };
  if (!data.nombre) return toast('Nombre obligatorio', 'error');
  
  closeModal('modal-kit');
  await create(TBL.kits, data);
  await loadAll();
  renderKits();
  toast('Kit creado');
}

async function saveExtra() {
  const data = {
    cliente_email: S.clienteEmail,
    fecha: $('#extra-fecha').value,
    propiedad_nombre: $('#extra-prop').value,
    concepto: $('#extra-concepto').value.trim(),
    importe: parseFloat($('#extra-importe').value) || 0
  };
  if (!data.fecha || !data.propiedad_nombre || !data.concepto) return toast('Campos obligatorios', 'error');
  
  closeModal('modal-extra');
  await create(TBL.extras, data);
  await loadAll();
  renderExtras();
  toast('Extra aÃ±adido');
}

async function saveMantenimiento() {
  const data = {
    cliente_email: S.clienteEmail,
    fecha: $('#mant-fecha').value || new Date().toISOString().split('T')[0],
    propiedad_nombre: $('#mant-prop').value,
    titulo: $('#mant-titulo').value.trim(),
    descripcion: $('#mant-desc').value.trim(),
    importe: parseFloat($('#mant-importe').value) || 0,
    estado: $('#mant-estado-sel').value
  };
  if (!data.titulo || !data.propiedad_nombre) return toast('TÃ­tulo y propiedad obligatorios', 'error');
  
  closeModal('modal-mantenimiento');
  await create(TBL.mantenimiento, data);
  await loadAll();
  renderMantenimiento();
  renderDashboard();
  toast('Incidencia creada');
}

async function saveGasto() {
  const data = {
    cliente_email: S.clienteEmail,
    fecha: $('#gasto-fecha').value,
    propiedad_nombre: $('#gasto-prop').value,
    tipo: $('#gasto-tipo').value,
    concepto: $('#gasto-concepto').value.trim(),
    importe: parseFloat($('#gasto-importe').value) || 0
  };
  if (!data.fecha || !data.propiedad_nombre) return toast('Campos obligatorios', 'error');
  
  closeModal('modal-gasto');
  await create(TBL.gastos, data);
  await loadAll();
  renderGastos();
  toast('Gasto aÃ±adido');
}

async function saveAlertConfig() {
  const data = {
    cliente_email: S.clienteEmail,
    whatsapp_notificaciones: $('#alert-whatsapp').value.trim(),
    email_notificaciones: $('#alert-email').value.trim(),
    alerta_stock_bajo: $('#alert-stock').checked,
    recordatorio_semanal: $('#alert-semanal').checked
  };
  
  try {
    if (S.alertas?.id) {
      await fetch(`${API}/supa/patch/${TBL.alertas}?id=eq.${S.alertas.id}`, {
        method: 'PATCH',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(data)
      });
    } else {
      await create(TBL.alertas, data);
    }
    await loadAll();
    toast('ConfiguraciÃ³n guardada');
  } catch (e) { toast('Error', 'error'); }
}

// ===== ACTIONS =====
async function adjStock(id, delta) {
  const item = S.inventario.find(i => i.id === id);
  if (!item) return;
  const newStock = Math.max(0, item.stock + delta);
  
  await fetch(`${API}/supa/patch/${TBL.inventario}?id=eq.${id}`, {
    method: 'PATCH',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ stock: newStock })
  });
  
  item.stock = newStock;
  renderStock();
  renderDashboard();
}

function editServicio(id) {
  const s = S.servicios.find(x => x.id === id);
  if (!s) return;
  
  $('#serv-edit-id').value = id;
  $('#serv-propiedad-sel').value = s.propiedad_nombre;
  $('#serv-tipo').value = s.tipo_servicio || 'checkout';
  $('#serv-fecha-input').value = s.fecha_servicio;
  $('#serv-hora').value = s.hora_inicio || '';
  $('#serv-checkin').value = s.check_in || '';
  $('#serv-checkout').value = s.check_out || '';
  $('#serv-huesped').value = s.huesped_nombre || '';
  $('#serv-num-huespedes').value = s.num_huespedes || 2;
  $('#serv-empleado').value = s.empleado_id || '';
  $('#serv-precio').value = s.precio || '';
  $('#serv-estado-sel').value = s.estado || 'pendiente';
  $('#serv-prioridad').value = s.prioridad || 'normal';
  $('#serv-notas').value = s.notas || '';
  
  openModal('modal-servicio');
}

async function completarServicio(id) {
  if (!confirm('Â¿Marcar como completado?')) return;
  
  await fetch(`${API}/supa/patch/${TBL.servicios}?id=eq.${id}`, {
    method: 'PATCH',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ estado: 'completado', completado_at: new Date().toISOString() })
  });
  
  await loadAll();
  renderServicios();
  renderDashboard();
  toast('Servicio completado');
}

async function delExtra(id) {
  if (!confirm('Â¿Eliminar?')) return;
  await fetch(`${API}/supa/delete/${TBL.extras}?id=eq.${id}`, { method: 'DELETE' });
  await loadAll();
  renderExtras();
}

async function delGasto(id) {
  if (!confirm('Â¿Eliminar?')) return;
  await fetch(`${API}/supa/delete/${TBL.gastos}?id=eq.${id}`, { method: 'DELETE' });
  await loadAll();
  renderGastos();
}

// ===== HELPERS =====
const $ = sel => document.querySelector(sel);
const $$ = sel => document.querySelectorAll(sel);
const show = id => document.getElementById(id).style.display = 'flex';
const hide = id => document.getElementById(id).style.display = 'none';

async function create(tbl, data) {
  return fetch(`${API}/supa/create/${tbl}`, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify(data)
  });
}

function openModal(id) {
  document.getElementById(id).classList.add('open');
  
  // Populate selects
  populatePropSelect('serv-propiedad-sel');
  populatePropSelect('extra-prop');
  populatePropSelect('mant-prop');
  populatePropSelect('gasto-prop');
  
  // Empleados
  const empSel = $('#serv-empleado');
  if (empSel) {
    empSel.innerHTML = '<option value="">Sin asignar</option>' + S.empleados.filter(e => e.activo).map(e => `<option value="${e.id}">${e.nombre}</option>`).join('');
  }
  
  // Defaults
  const hoy = new Date().toISOString().split('T')[0];
  ['serv-fecha-input', 'extra-fecha', 'mant-fecha', 'gasto-fecha'].forEach(id => {
    const el = $('#' + id);
    if (el && !el.value) el.value = hoy;
  });
  
  // Clear edit ID
  if (id === 'modal-servicio' && !$('#serv-edit-id').value) {
    $('#serv-edit-id').value = '';
  }
}

function closeModal(id) {
  document.getElementById(id).classList.remove('open');
  // Reset form
  if (id === 'modal-servicio') {
    $('#serv-edit-id').value = '';
  }
}

function populatePropSelect(id) {
  const sel = $('#' + id);
  if (!sel) return;
  sel.innerHTML = '<option value="">Selecciona...</option>' + S.propiedades.map(p => `<option value="${p.propiedad_nombre}">${p.propiedad_nombre}</option>`).join('');
}

function initFilters() {
  // Propiedades filter
  const propFilter = $('#serv-propiedad');
  if (propFilter) {
    propFilter.innerHTML = '<option value="">Todas las propiedades</option>' + S.propiedades.map(p => `<option value="${p.propiedad_nombre}">${p.propiedad_nombre}</option>`).join('');
  }
  
  // Month selectors
  const months = [];
  const now = new Date();
  for (let i = -6; i <= 3; i++) {
    const d = new Date(now.getFullYear(), now.getMonth() + i, 1);
    months.push({
      value: `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}`,
      label: d.toLocaleDateString('es-ES', { month: 'long', year: 'numeric' })
    });
  }
  const current = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}`;
  
  ['extras-mes', 'gastos-mes'].forEach(id => {
    const el = $('#' + id);
    if (el) {
      el.innerHTML = months.map(m => `<option value="${m.value}" ${m.value === current ? 'selected' : ''}>${m.label}</option>`).join('');
    }
  });
  
  // Date filter default
  const servFecha = $('#serv-fecha');
  if (servFecha && !servFecha.value) {
    servFecha.value = now.toISOString().split('T')[0];
  }
}

function toast(msg, type = 'success') {
  const el = $('#toast');
  $('#toast-msg').textContent = msg;
  $('#toast-icon').textContent = type === 'error' ? 'âœ•' : 'âœ“';
  el.className = `toast show ${type}`;
  setTimeout(() => el.classList.remove('show'), 3000);
}

function formatDate(d) {
  if (!d) return '-';
  return new Date(d).toLocaleDateString('es-ES', { day: '2-digit', month: 'short' });
}

function estadoBadge(e) {
  const map = { pendiente: 'badge-warning', confirmado: 'badge-accent', en_proceso: 'badge-warning', completado: 'badge-success', cancelado: 'badge-danger' };
  return map[e] || 'badge-neutral';
}

function empty(icon, text) {
  return `<div class="empty-state" style="grid-column:1/-1;"><div class="empty-state-icon">${icon}</div><h3>${text}</h3></div>`;
}

// ===== INTEGRACIONES =====
async function loadIntegraciones() {
  try {
    // Cargar credenciales
    const credRes = await fetch(`${API}/supa/list/${TBL.credenciales}?cliente_email=eq.${encodeURIComponent(S.clienteEmail)}`);
    S.credenciales = await credRes.json();
    
    // Cargar property mappings
    const mapRes = await fetch(`${API}/supa/list/${TBL.propertyMapping}?cliente_email=eq.${encodeURIComponent(S.clienteEmail)}`);
    S.propertyMappings = await mapRes.json();
    
    renderIntegraciones();
  } catch (e) {
    console.error('Error loading integraciones:', e);
  }
}

function renderIntegraciones() {
  // Stats
  const activas = S.credenciales.filter(c => c.activo).length;
  $('#stat-integraciones').textContent = activas;
  $('#stat-props-importadas').textContent = S.propertyMappings.length;
  
  // Last sync
  const lastSync = S.credenciales.reduce((latest, c) => {
    if (c.last_sync_at && (!latest || new Date(c.last_sync_at) > new Date(latest))) {
      return c.last_sync_at;
    }
    return latest;
  }, null);
  $('#stat-last-sync').textContent = lastSync ? formatDate(lastSync) : '-';
  
  // Update platform statuses
  Object.keys(PLATFORMS).forEach(p => {
    const cred = S.credenciales.find(c => c.plataforma === p);
    const statusEl = $(`#status-${p}`);
    const cardEl = statusEl?.closest('.integration-card');
    
    if (cred && cred.activo) {
      statusEl.textContent = 'âœ“ Conectado';
      statusEl.style.color = 'var(--success)';
      cardEl?.classList.add('connected');
    } else {
      statusEl.textContent = 'No conectado';
      statusEl.style.color = 'var(--text-muted)';
      cardEl?.classList.remove('connected');
    }
  });
  
  // Table
  const tbody = $('#integraciones-tbody');
  const emptyEl = $('#integraciones-empty');
  
  if (!S.credenciales.length) {
    tbody.innerHTML = '';
    emptyEl.style.display = 'block';
    return;
  }
  
  emptyEl.style.display = 'none';
  tbody.innerHTML = S.credenciales.map(c => {
    const props = S.propertyMappings.filter(p => 
      (c.plataforma === 'avaibook' && p.avaibook_accommodation_id) ||
      (c.plataforma === 'icnea' && p.icnea_lodging_id) ||
      (c.plataforma === 'hostify' && p.hostify_property_id)
    ).length;
    
    const statusClass = c.activo ? (c.last_sync_status === 'error' ? 'badge-danger' : 'badge-success') : 'badge-neutral';
    const statusText = c.activo ? (c.last_sync_status === 'error' ? 'Error' : 'Activo') : 'Inactivo';
    const nombreCuenta = c.nombre_cuenta || PLATFORMS[c.plataforma]?.name || c.plataforma;
    
    return `
      <tr>
        <td>
          <strong>${nombreCuenta}</strong>
          <div style="font-size:0.75rem; color:var(--text-muted);">${PLATFORMS[c.plataforma]?.name || c.plataforma}</div>
        </td>
        <td><span class="badge ${statusClass}">${statusText}</span></td>
        <td>${props}</td>
        <td>${c.last_sync_at ? formatDate(c.last_sync_at) : 'Nunca'}</td>
        <td style="white-space:nowrap;">
          <button class="btn btn-sm btn-secondary" onclick="syncPropiedades('${c.plataforma}')" title="Importar propiedades">ğŸ </button>
          <button class="btn btn-sm btn-secondary" onclick="syncReservas('${c.plataforma}')" title="Sincronizar reservas">ğŸ“…</button>
          <button class="btn btn-sm btn-secondary" onclick="openIntegrationModal('${c.plataforma}', ${c.id})" title="Editar">âœï¸</button>
        </td>
      </tr>
    `;
  }).join('');
  
  // Props table
  renderPropsImportadas();
}

function renderPropsImportadas() {
  const tbody = $('#props-importadas-tbody');
  if (!tbody) return;
  
  if (!S.propertyMappings.length) {
    tbody.innerHTML = '<tr><td colspan="7" style="text-align:center; color:var(--text-muted); padding:30px;">No hay propiedades importadas</td></tr>';
    return;
  }
  
  tbody.innerHTML = S.propertyMappings.map(p => {
    const origen = p.avaibook_accommodation_id ? 'Avaibook' : 
                   p.icnea_lodging_id ? 'Icnea' : 
                   p.hostify_property_id ? 'Hostify' : 'Manual';
    const extId = p.avaibook_accommodation_id || p.icnea_lodging_id || p.hostify_property_id || '-';
    
    return `
      <tr>
        <td><strong>${p.propiedad_nombre || p.nombre_externo || 'Sin nombre'}</strong></td>
        <td><span class="badge badge-neutral">${origen}</span></td>
        <td style="font-size:0.8rem; color:var(--text-muted);">${extId}</td>
        <td>${p.total_rooms || '-'}</td>
        <td>${p.total_camas_dobles || 0}D / ${p.total_camas_individuales || 0}I</td>
        <td>â‚¬${p.precio_limpieza || 45}</td>
        <td>
          <button class="btn btn-sm btn-secondary" onclick="editPropMapping(${p.id})">âœï¸</button>
        </td>
      </tr>
    `;
  }).join('');
}

function openIntegrationModal(plataforma, editId = null) {
  const platform = PLATFORMS[plataforma];
  if (!platform) return;
  
  $('#integ-plataforma').value = plataforma;
  $('#integ-edit-id').value = editId || '';
  $('#integ-modal-title').textContent = `ğŸ”— ${platform.name}`;
  $('#integ-help-text').textContent = platform.help;
  
  // Show/hide fields based on platform
  $('#integ-fields-apikey').style.display = platform.fields.includes('apikey') ? 'block' : 'none';
  $('#integ-fields-userid').style.display = platform.fields.includes('userid') ? 'block' : 'none';
  $('#integ-fields-secret').style.display = platform.fields.includes('secret') ? 'block' : 'none';
  
  // Clear fields
  $('#integ-nombre').value = '';
  $('#integ-apikey').value = '';
  $('#integ-userid').value = '';
  $('#integ-secret').value = '';
  $('#integ-interval').value = '60';
  $('#integ-activo').checked = true;
  
  // If editing, load existing data
  if (editId) {
    const cred = S.credenciales.find(c => c.id === editId);
    if (cred) {
      $('#integ-nombre').value = cred.nombre_cuenta || '';
      $('#integ-apikey').value = cred.api_key || '';
      $('#integ-userid').value = cred.user_id || '';
      $('#integ-secret').value = cred.api_secret || '';
      $('#integ-interval').value = cred.sync_interval_minutes || 60;
      $('#integ-activo').checked = cred.activo;
    }
    $('#integ-btn-delete').style.display = 'block';
  } else {
    // Sugerir nombre por defecto
    const existingCount = S.credenciales.filter(c => c.plataforma === plataforma).length;
    $('#integ-nombre').value = existingCount > 0 ? `${platform.name} ${existingCount + 1}` : platform.name;
    $('#integ-btn-delete').style.display = 'none';
  }
  
  document.getElementById('modal-integracion').classList.add('open');
}

async function saveIntegracion() {
  const plataforma = $('#integ-plataforma').value;
  const editId = $('#integ-edit-id').value;
  const nombreCuenta = $('#integ-nombre').value.trim();
  const apiKey = $('#integ-apikey').value.trim();
  const userId = $('#integ-userid').value.trim();
  const secret = $('#integ-secret').value.trim();
  const interval = parseInt($('#integ-interval').value);
  const activo = $('#integ-activo').checked;
  
  if (!nombreCuenta) {
    toast('Nombre de cuenta es requerido', 'error');
    return;
  }
  if (!apiKey) {
    toast('API Key es requerido', 'error');
    return;
  }
  
  const data = {
    cliente_email: S.clienteEmail,
    plataforma,
    nombre_cuenta: nombreCuenta,
    api_key: apiKey,
    user_id: userId || null,
    api_secret: secret || null,
    sync_interval_minutes: interval,
    activo
  };
  
  console.log('Saving integration:', data);
  
  try {
    let res;
    
    if (editId) {
      // Editar existente
      res = await fetch(`${API}/supa/patch/${TBL.credenciales}?id=eq.${editId}`, {
        method: 'PATCH',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(data)
      });
    } else {
      // Crear nuevo
      res = await fetch(`${API}/supa/create/${TBL.credenciales}`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(data)
      });
    }
    
    console.log('Response status:', res.status);
    const responseText = await res.text();
    console.log('Response body:', responseText);
    
    if (!res.ok) {
      throw new Error(responseText || 'Error al guardar');
    }
    
    toast('IntegraciÃ³n guardada correctamente');
    closeModal('modal-integracion');
    await loadIntegraciones();
    
    // Preguntar si quiere importar propiedades ahora
    if (!editId && confirm('Â¿Importar propiedades de ' + PLATFORMS[plataforma].name + ' ahora?')) {
      await syncPropiedades(plataforma);
    }
    
  } catch (e) {
    console.error('Error saving integration:', e);
    toast('Error: ' + e.message, 'error');
  }
}

async function syncPropiedades(plataforma) {
  toast('Importando propiedades de ' + (PLATFORMS[plataforma]?.name || plataforma) + '...');
  
  // URL del webhook de n8n (ajusta a tu instancia)
  const n8nWebhookBase = 'https://n8n.adrianmartinbernabe.com/webhook';
  const webhookUrl = `${n8nWebhookBase}/cleanmanager/sync/propiedades/${plataforma}`;
  
  try {
    const res = await fetch(webhookUrl, { 
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ cliente_email: S.clienteEmail })
    });
    
    if (res.ok) {
      const result = await res.json();
      toast(`âœ… ${result.count || 0} propiedades importadas`);
      await loadIntegraciones();
    } else {
      toast('Error al importar propiedades', 'error');
    }
  } catch (e) {
    console.error('Sync error:', e);
    toast('No se pudo conectar con n8n. Verifica que el workflow estÃ© activo.', 'error');
  }
}

async function syncReservas(plataforma) {
  toast('Sincronizando reservas de ' + (PLATFORMS[plataforma]?.name || plataforma) + '...');
  
  const n8nWebhookBase = 'https://n8n.adrianmartinbernabe.com/webhook';
  const webhookUrl = `${n8nWebhookBase}/cleanmanager/sync/reservas/${plataforma}`;
  
  try {
    const res = await fetch(webhookUrl, { 
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ cliente_email: S.clienteEmail })
    });
    
    if (res.ok) {
      toast('âœ… Reservas sincronizadas');
      await loadIntegraciones();
    } else {
      toast('Error al sincronizar reservas', 'error');
    }
  } catch (e) {
    console.error('Sync error:', e);
    toast('No se pudo conectar con n8n', 'error');
  }
}

async function deleteIntegracion() {
  const editId = $('#integ-edit-id').value;
  if (!editId) return;
  
  if (!confirm('Â¿Eliminar esta integraciÃ³n? Las propiedades importadas se mantendrÃ¡n.')) return;
  
  try {
    await fetch(`${API}/supa/delete/${TBL.credenciales}?id=eq.${editId}`, { method: 'DELETE' });
    toast('IntegraciÃ³n eliminada');
    closeModal('modal-integracion');
    await loadIntegraciones();
  } catch (e) {
    toast('Error al eliminar', 'error');
  }
}

async function syncAllProperties() {
  toast('Sincronizando todas las propiedades...');
  
  // Sync cada plataforma que tenga credenciales activas
  const plataformas = [...new Set(S.credenciales.filter(c => c.activo).map(c => c.plataforma))];
  
  for (const plataforma of plataformas) {
    await syncPropiedades(plataforma);
  }
}

function editPropMapping(id) {
  const prop = S.propertyMappings.find(p => p.id === id);
  if (!prop) return;
  
  $('#map-prop-id').value = id;
  $('#map-prop-nombre').value = prop.propiedad_nombre || '';
  $('#map-prop-rooms').value = prop.total_rooms || 1;
  $('#map-prop-baths').value = prop.total_bathrooms || 1;
  $('#map-prop-camas-dobles').value = prop.total_camas_dobles || 0;
  $('#map-prop-camas-ind').value = prop.total_camas_individuales || 0;
  $('#map-prop-precio').value = prop.precio_limpieza || 45;
  $('#map-prop-duracion').value = prop.duracion_limpieza_minutos || 90;
  
  document.getElementById('modal-mapear-prop').classList.add('open');
}

async function savePropMapping() {
  const id = $('#map-prop-id').value;
  
  const data = {
    propiedad_nombre: $('#map-prop-nombre').value.trim(),
    total_rooms: parseInt($('#map-prop-rooms').value) || 1,
    total_bathrooms: parseInt($('#map-prop-baths').value) || 1,
    total_camas_dobles: parseInt($('#map-prop-camas-dobles').value) || 0,
    total_camas_individuales: parseInt($('#map-prop-camas-ind').value) || 0,
    precio_limpieza: parseFloat($('#map-prop-precio').value) || 45,
    duracion_limpieza_minutos: parseInt($('#map-prop-duracion').value) || 90
  };
  
  if (!data.propiedad_nombre) {
    toast('Nombre es requerido', 'error');
    return;
  }
  
  try {
    await fetch(`${API}/supa/patch/${TBL.propertyMapping}?id=eq.${id}`, {
      method: 'PATCH',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(data)
    });
    
    toast('Propiedad actualizada');
    closeModal('modal-mapear-prop');
    await loadIntegraciones();
  } catch (e) {
    toast('Error al guardar', 'error');
  }
}

// ===============================================
// FORECAST DE STOCK
// ===============================================
let stockForecasts = new Map();

function calculateForecasts() {
  stockForecasts.clear();
  const today = new Date();
  const futureReservas = S.reservas.filter(r => {
    const fecha = new Date(r.fecha_servicio || r.checkout);
    return fecha >= today && r.estado !== 'cancelado';
  }).sort((a, b) => new Date(a.fecha_servicio || a.checkout) - new Date(b.fecha_servicio || b.checkout));

  for (const item of S.stock) {
    let stockSimulado = item.stock;
    let fechaRotura = null;
    
    for (const reserva of futureReservas) {
      const consumo = calcConsumoReserva(item, reserva);
      stockSimulado -= consumo;
      
      if (stockSimulado <= 0 && !fechaRotura) {
        fechaRotura = reserva.fecha_servicio || reserva.checkout;
        break;
      }
    }
    
    stockForecasts.set(item.id, {
      stockFinal: Math.max(0, stockSimulado),
      fechaRotura: fechaRotura,
      reservasPendientes: futureReservas.length
    });
  }
  
  updateForecastBadges();
}

function calcConsumoReserva(item, reserva) {
  let consumo = 0;
  consumo += item.consumo_por_limpieza || 0;
  consumo += (item.consumo_habitacion || 0) * (reserva.habitaciones || reserva.total_rooms || 1);
  consumo += (item.consumo_bano || 0) * (reserva.banos || reserva.total_bathrooms || 1);
  consumo += (item.consumo_cama_doble || 0) * (reserva.camas_dobles || 0);
  consumo += (item.consumo_cama_indiv || 0) * (reserva.camas_individuales || 0);
  consumo += (item.consumo_huesped || 0) * (reserva.huespedes || reserva.guests || 1);
  consumo += (item.consumo_adulto || 0) * (reserva.adultos || 0);
  consumo += (item.consumo_nino || 0) * (reserva.ninos || 0);
  consumo += (item.consumo_bebe || 0) * (reserva.bebes || 0);
  return consumo;
}

function updateForecastBadges() {
  let bajoMin = 0, agotaran = 0, ok = 0;
  
  for (const item of S.stock) {
    const forecast = stockForecasts.get(item.id);
    if (item.stock < item.stock_minimo) {
      bajoMin++;
    } else if (forecast?.fechaRotura) {
      agotaran++;
    } else {
      ok++;
    }
  }
  
  $('#stat-bajo-min').textContent = bajoMin;
  $('#stat-agotaran').textContent = agotaran;
  $('#stat-ok').textContent = ok;
  $('#alert-bajo-min').textContent = bajoMin;
  $('#alert-agotaran').textContent = agotaran;
  $('#alert-ok').textContent = ok;
  
  const badge = $('#stock-alert-badge');
  if (bajoMin > 0) {
    badge.textContent = bajoMin;
    badge.style.display = 'block';
  } else {
    badge.style.display = 'none';
  }
}

// ===============================================
// LIMPIEZAS MENSUALES
// ===============================================
let currentLimpiezasMes = new Date().toISOString().slice(0, 7);

function changeMonth(delta) {
  const [year, month] = currentLimpiezasMes.split('-').map(Number);
  const newDate = new Date(year, month - 1 + delta, 1);
  currentLimpiezasMes = newDate.toISOString().slice(0, 7);
  renderLimpiezasMes();
}

function renderLimpiezasMes() {
  const [year, month] = currentLimpiezasMes.split('-');
  const mesLabel = new Date(year, month - 1).toLocaleDateString('es-ES', { month: 'long', year: 'numeric' });
  $('#limpiezas-mes-label').textContent = mesLabel.charAt(0).toUpperCase() + mesLabel.slice(1);
  
  // Filtrar propietario
  const propSelect = $('#limpiezas-propietario');
  propSelect.innerHTML = '<option value="">Todos los propietarios</option>' + 
    S.propietarios.map(p => `<option value="${p.id}">${p.nombre}</option>`).join('');
  
  const propFiltro = propSelect.value;
  
  // Filtrar servicios del mes
  const serviciosMes = S.servicios.filter(s => {
    const fecha = (s.fecha_servicio || '').slice(0, 7);
    if (fecha !== currentLimpiezasMes) return false;
    if (propFiltro) {
      const prop = S.propiedades.find(p => p.id === s.propiedad_id);
      if (!prop || prop.propietario_id != propFiltro) return false;
    }
    return true;
  });
  
  let totalLimpiezas = serviciosMes.length;
  let costeGestor = 0, costePropietario = 0;
  
  const tbody = $('#limpiezas-table');
  tbody.innerHTML = serviciosMes.map(s => {
    const prop = S.propiedades.find(p => p.id === s.propiedad_id) || {};
    const precioBase = prop.precio_limpieza || 45;
    const extras = S.extras.filter(e => e.servicio_id === s.id).reduce((sum, e) => sum + (e.importe || 0), 0);
    const total = precioBase + extras;
    const paga = prop.pago_limpieza || 'gestor';
    
    if (paga === 'gestor') costeGestor += total;
    else costePropietario += total;
    
    return `<tr>
      <td>${formatDate(s.fecha_servicio)}</td>
      <td>${prop.nombre || '-'}</td>
      <td><span class="badge badge-${s.tipo === 'checkout' ? 'accent' : 'neutral'}">${s.tipo || 'normal'}</span></td>
      <td>${formatMoney(precioBase)}</td>
      <td>${extras > 0 ? formatMoney(extras) : '-'}</td>
      <td><strong>${formatMoney(total)}</strong></td>
      <td><span class="badge ${paga === 'gestor' ? 'badge-accent' : 'badge-warning'}">${paga}</span></td>
      <td><button class="btn btn-sm btn-secondary" onclick="editServicio(${s.id})">âœï¸</button></td>
    </tr>`;
  }).join('') || '<tr><td colspan="8" style="text-align:center; color:var(--text-muted);">Sin limpiezas este mes</td></tr>';
  
  $('#limp-total').textContent = totalLimpiezas;
  $('#limp-gestor').textContent = formatMoney(costeGestor);
  $('#limp-propietario').textContent = formatMoney(costePropietario);
  $('#limp-total-cost').textContent = formatMoney(costeGestor + costePropietario);
}

// ===============================================
// CONSUMOS MENSUALES
// ===============================================
let currentConsumosMes = new Date().toISOString().slice(0, 7);
let consumosChart = null;

function changeConsumosMes(delta) {
  const [year, month] = currentConsumosMes.split('-').map(Number);
  const newDate = new Date(year, month - 1 + delta, 1);
  currentConsumosMes = newDate.toISOString().slice(0, 7);
  renderConsumos();
}

function renderConsumos() {
  const [year, month] = currentConsumosMes.split('-');
  const mesLabel = new Date(year, month - 1).toLocaleDateString('es-ES', { month: 'long', year: 'numeric' });
  $('#consumos-mes-label').textContent = mesLabel.charAt(0).toUpperCase() + mesLabel.slice(1);
  
  const gastos = calcGastosMes(currentConsumosMes);
  
  $('#consumo-total').textContent = formatMoney(gastos.total);
  $('#consumo-reservas').textContent = gastos.numReservas;
  $('#consumo-gestor').textContent = formatMoney(gastos.gestor);
  $('#consumo-propietario').textContent = formatMoney(gastos.propietario);
  
  // Desglose
  const desglose = $('#consumos-desglose');
  desglose.innerHTML = gastos.desglose.map(g => `
    <div class="consumo-item">
      <div>
        <span class="consumo-nombre">${g.nombre}</span>
        <span class="consumo-pagador ${g.pagador}">${g.pagador === 'gestor' ? 'ğŸ¢' : 'ğŸ‘¤'}</span>
      </div>
      <div>
        <span style="color:var(--text-muted);">${g.unidades} uds Ã— ${formatMoney(g.precioUnitario)}</span>
        <span class="consumo-valor">${formatMoney(g.total)}</span>
      </div>
    </div>
  `).join('') || '<p style="color:var(--text-muted);">Sin consumos este mes</p>';
  
  // ProyecciÃ³n
  renderProyeccion();
  
  // GrÃ¡fico
  renderConsumosChart();
}

function calcGastosMes(mes) {
  const reservasMes = S.servicios.filter(s => (s.fecha_servicio || '').slice(0, 7) === mes && s.estado === 'completado');
  
  let total = 0, gestor = 0, propietario = 0;
  const desglose = [];
  
  for (const item of S.stock) {
    let unidadesConsumidas = 0;
    
    for (const reserva of reservasMes) {
      unidadesConsumidas += calcConsumoReserva(item, reserva);
    }
    
    if (unidadesConsumidas > 0) {
      const precio = item.precio_unidad || 0;
      const subtotal = unidadesConsumidas * precio;
      const pagador = item.pagado_por || 'gestor';
      
      total += subtotal;
      if (pagador === 'gestor') gestor += subtotal;
      else propietario += subtotal;
      
      desglose.push({
        nombre: item.item,
        unidades: unidadesConsumidas,
        precioUnitario: precio,
        total: subtotal,
        pagador: pagador
      });
    }
  }
  
  return { total, gestor, propietario, numReservas: reservasMes.length, desglose };
}

function renderProyeccion() {
  const today = new Date();
  const [year, month] = currentConsumosMes.split('-').map(Number);
  
  if (year !== today.getFullYear() || month !== today.getMonth() + 1) {
    $('#consumos-proyeccion').innerHTML = '<p style="color:var(--text-muted);">ProyecciÃ³n solo disponible para el mes actual</p>';
    return;
  }
  
  const reservasFuturas = S.servicios.filter(s => {
    const fecha = new Date(s.fecha_servicio);
    return fecha > today && fecha.getMonth() === today.getMonth() && s.estado !== 'cancelado';
  });
  
  let proyeccion = 0;
  for (const reserva of reservasFuturas) {
    for (const item of S.stock) {
      proyeccion += calcConsumoReserva(item, reserva) * (item.precio_unidad || 0);
    }
  }
  
  $('#consumos-proyeccion').innerHTML = `
    <div class="stats-grid">
      <div class="stat-card">
        <div class="stat-label">Reservas pendientes</div>
        <div class="stat-value">${reservasFuturas.length}</div>
      </div>
      <div class="stat-card accent">
        <div class="stat-label">Gasto proyectado restante</div>
        <div class="stat-value">${formatMoney(proyeccion)}</div>
      </div>
    </div>
  `;
}

function renderConsumosChart() {
  const ctx = document.getElementById('consumos-chart');
  if (!ctx) return;
  
  // Calcular Ãºltimos 6 meses
  const meses = [];
  const valores = [];
  const [year, month] = currentConsumosMes.split('-').map(Number);
  
  for (let i = 5; i >= 0; i--) {
    const d = new Date(year, month - 1 - i, 1);
    const mesKey = d.toISOString().slice(0, 7);
    const mesLabel = d.toLocaleDateString('es-ES', { month: 'short' });
    meses.push(mesLabel);
    valores.push(calcGastosMes(mesKey).total);
  }
  
  if (consumosChart) consumosChart.destroy();
  
  // Simple canvas chart
  const context = ctx.getContext('2d');
  const width = ctx.width = ctx.parentElement.offsetWidth - 40;
  const height = ctx.height = 200;
  const padding = 40;
  const maxVal = Math.max(...valores, 1);
  
  context.clearRect(0, 0, width, height);
  context.fillStyle = '#1c1c26';
  context.fillRect(0, 0, width, height);
  
  const barWidth = (width - padding * 2) / meses.length - 10;
  
  meses.forEach((mes, i) => {
    const x = padding + i * ((width - padding * 2) / meses.length) + 5;
    const barHeight = (valores[i] / maxVal) * (height - padding * 2);
    const y = height - padding - barHeight;
    
    // Bar
    context.fillStyle = '#6366f1';
    context.fillRect(x, y, barWidth, barHeight);
    
    // Label
    context.fillStyle = '#a1a1aa';
    context.font = '11px DM Sans';
    context.textAlign = 'center';
    context.fillText(mes, x + barWidth / 2, height - 10);
    
    // Value
    context.fillStyle = '#f4f4f5';
    context.fillText(valores[i].toFixed(0) + 'â‚¬', x + barWidth / 2, y - 5);
  });
}

// ===============================================
// INFORMES PDF Y EXCEL
// ===============================================
function generarInformePDF() {
  const mes = $('#informe-mes').value || currentConsumosMes;
  const tipo = $('#informe-tipo').value;
  
  let content = '';
  const [year, month] = mes.split('-');
  const mesLabel = new Date(year, month - 1).toLocaleDateString('es-ES', { month: 'long', year: 'numeric' });
  
  if (tipo === 'mensual') {
    const gastos = calcGastosMes(mes);
    const serviciosMes = S.servicios.filter(s => (s.fecha_servicio || '').slice(0, 7) === mes);
    
    content = `
      <html><head><title>Informe ${mesLabel}</title>
      <style>body{font-family:Arial,sans-serif;padding:40px;max-width:800px;margin:auto}h1{color:#6366f1}h2{color:#333;border-bottom:2px solid #6366f1;padding-bottom:10px}table{width:100%;border-collapse:collapse;margin:20px 0}th,td{padding:12px;border:1px solid #ddd;text-align:left}th{background:#f8f9fa}.total{font-weight:bold;background:#eff6ff}.stat-box{display:inline-block;padding:15px 25px;background:#f8f9fa;border-radius:8px;margin:10px 10px 10px 0;text-align:center}.stat-box .num{font-size:24px;font-weight:bold;color:#6366f1}.stat-box .label{font-size:12px;color:#666}</style>
      </head><body>
      <h1>ğŸ“Š Informe Mensual</h1>
      <h2>${mesLabel.charAt(0).toUpperCase() + mesLabel.slice(1)}</h2>
      
      <div class="stat-box"><div class="num">${serviciosMes.length}</div><div class="label">Limpiezas</div></div>
      <div class="stat-box"><div class="num">${formatMoney(gastos.total)}</div><div class="label">Consumos Total</div></div>
      <div class="stat-box"><div class="num">${formatMoney(gastos.gestor)}</div><div class="label">Paga Gestor</div></div>
      <div class="stat-box"><div class="num">${formatMoney(gastos.propietario)}</div><div class="label">Paga Propietario</div></div>
      
      <h2>ğŸ“‹ Desglose de Consumos</h2>
      <table>
        <tr><th>ArtÃ­culo</th><th>Unidades</th><th>Precio/Ud</th><th>Total</th><th>Paga</th></tr>
        ${gastos.desglose.map(g => `<tr><td>${g.nombre}</td><td>${g.unidades}</td><td>${formatMoney(g.precioUnitario)}</td><td>${formatMoney(g.total)}</td><td>${g.pagador}</td></tr>`).join('')}
        <tr class="total"><td colspan="3">TOTAL</td><td>${formatMoney(gastos.total)}</td><td></td></tr>
      </table>
      
      <p style="margin-top:40px;color:#666;font-size:12px">Generado el ${new Date().toLocaleDateString('es-ES')} - CleanManager Pro</p>
      </body></html>
    `;
  } else if (tipo === 'propietario') {
    const propId = $('#informe-propietario').value;
    const prop = S.propietarios.find(p => p.id == propId);
    if (!prop) { toast('Selecciona un propietario', 'error'); return; }
    
    content = generarInformePropietarioPDF(prop, mes, mesLabel);
  } else if (tipo === 'consumos') {
    const gastos = calcGastosMes(mes);
    content = `<html><head><title>Consumos ${mesLabel}</title><style>body{font-family:Arial;padding:40px}h1{color:#6366f1}table{width:100%;border-collapse:collapse}th,td{padding:10px;border:1px solid #ddd}th{background:#f8f9fa}</style></head><body><h1>ğŸ’° Consumos Detallado - ${mesLabel}</h1><table><tr><th>ArtÃ­culo</th><th>Unidades</th><th>Precio</th><th>Total</th><th>Pagador</th></tr>${gastos.desglose.map(g => `<tr><td>${g.nombre}</td><td>${g.unidades}</td><td>${formatMoney(g.precioUnitario)}</td><td>${formatMoney(g.total)}</td><td>${g.pagador}</td></tr>`).join('')}</table></body></html>`;
  } else if (tipo === 'limpiezas') {
    const serviciosMes = S.servicios.filter(s => (s.fecha_servicio || '').slice(0, 7) === mes);
    content = `<html><head><title>Limpiezas ${mesLabel}</title><style>body{font-family:Arial;padding:40px}h1{color:#6366f1}table{width:100%;border-collapse:collapse}th,td{padding:10px;border:1px solid #ddd}th{background:#f8f9fa}</style></head><body><h1>ğŸ§¹ Limpiezas - ${mesLabel}</h1><table><tr><th>Fecha</th><th>Propiedad</th><th>Tipo</th><th>Estado</th></tr>${serviciosMes.map(s => { const p = S.propiedades.find(pr => pr.id === s.propiedad_id); return `<tr><td>${formatDate(s.fecha_servicio)}</td><td>${p?.nombre || '-'}</td><td>${s.tipo || 'normal'}</td><td>${s.estado}</td></tr>`; }).join('')}</table></body></html>`;
  }
  
  // Preview
  $('#informe-preview').innerHTML = `<iframe srcdoc="${content.replace(/"/g, '&quot;')}" style="width:100%;height:400px;border:none;border-radius:8px;"></iframe>`;
  
  // Open print
  const win = window.open('', '_blank');
  win.document.write(content);
  win.document.close();
  win.print();
  
  toast('ğŸ“„ PDF generado', 'success');
}

function generarInformePropietarioPDF(prop, mes, mesLabel) {
  const propiedadesProp = S.propiedades.filter(p => p.propietario_id === prop.id);
  const propIds = propiedadesProp.map(p => p.id);
  
  const serviciosMes = S.servicios.filter(s => 
    (s.fecha_servicio || '').slice(0, 7) === mes && propIds.includes(s.propiedad_id)
  );
  
  let totalLimpiezas = 0, gastosLimpieza = 0;
  serviciosMes.forEach(s => {
    const p = propiedadesProp.find(pr => pr.id === s.propiedad_id);
    if (p?.pago_limpieza === 'propietario') {
      totalLimpiezas++;
      gastosLimpieza += p.precio_limpieza || 45;
    }
  });
  
  // Consumos del propietario
  let gastosConsumos = 0;
  const consumosProp = [];
  for (const item of S.stock) {
    if (item.pagado_por !== 'propietario') continue;
    let unidades = 0;
    for (const s of serviciosMes) {
      unidades += calcConsumoReserva(item, s);
    }
    if (unidades > 0) {
      const subtotal = unidades * (item.precio_unidad || 0);
      gastosConsumos += subtotal;
      consumosProp.push({ nombre: item.item, unidades, precio: item.precio_unidad, total: subtotal });
    }
  }
  
  return `
    <html><head><title>Informe ${prop.nombre} - ${mesLabel}</title>
    <style>body{font-family:Arial;padding:40px;max-width:800px;margin:auto}h1{color:#6366f1}h2{border-bottom:2px solid #6366f1;padding-bottom:10px}table{width:100%;border-collapse:collapse;margin:20px 0}th,td{padding:10px;border:1px solid #ddd}th{background:#f8f9fa}.total{font-weight:bold;background:#eff6ff}.highlight{background:#fff3cd;padding:20px;border-radius:8px;margin:20px 0}</style>
    </head><body>
    <h1>ğŸ‘¤ Informe para ${prop.nombre}</h1>
    <h2>${mesLabel.charAt(0).toUpperCase() + mesLabel.slice(1)}</h2>
    
    <p><strong>Propiedades:</strong> ${propiedadesProp.map(p => p.nombre).join(', ')}</p>
    
    <h2>ğŸ§¹ Limpiezas a cargo del propietario</h2>
    <p>Total: <strong>${totalLimpiezas}</strong> limpiezas = <strong>${formatMoney(gastosLimpieza)}</strong></p>
    
    <h2>ğŸ“¦ Consumos a cargo del propietario</h2>
    <table>
      <tr><th>ArtÃ­culo</th><th>Unidades</th><th>Precio/Ud</th><th>Total</th></tr>
      ${consumosProp.map(c => `<tr><td>${c.nombre}</td><td>${c.unidades}</td><td>${formatMoney(c.precio)}</td><td>${formatMoney(c.total)}</td></tr>`).join('')}
    </table>
    
    <div class="highlight">
      <h3>ğŸ’° TOTAL A PAGAR POR EL PROPIETARIO</h3>
      <p style="font-size:24px;color:#6366f1;margin:10px 0"><strong>${formatMoney(gastosLimpieza + gastosConsumos)}</strong></p>
      <p>Limpiezas: ${formatMoney(gastosLimpieza)} + Consumos: ${formatMoney(gastosConsumos)}</p>
    </div>
    
    <p style="margin-top:40px;color:#666;font-size:12px">Generado el ${new Date().toLocaleDateString('es-ES')} - CleanManager Pro</p>
    </body></html>
  `;
}

function exportarExcel() {
  const mes = $('#excel-mes').value || currentConsumosMes;
  const tipo = $('#excel-tipo').value;
  
  let csv = '';
  
  if (tipo === 'completo' || tipo === 'inventario') {
    csv += 'INVENTARIO\n';
    csv += 'ArtÃ­culo,Stock,MÃ­nimo,Precio,Pagado Por\n';
    S.stock.forEach(i => {
      csv += `"${i.item}",${i.stock},${i.stock_minimo},${i.precio_unidad || 0},${i.pagado_por || 'gestor'}\n`;
    });
    csv += '\n';
  }
  
  if (tipo === 'completo' || tipo === 'gastos') {
    const gastos = calcGastosMes(mes);
    csv += 'GASTOS DEL MES\n';
    csv += 'ArtÃ­culo,Unidades,Precio Unitario,Total,Pagador\n';
    gastos.desglose.forEach(g => {
      csv += `"${g.nombre}",${g.unidades},${g.precioUnitario},${g.total},${g.pagador}\n`;
    });
    csv += `\nTOTAL,,, ${gastos.total}\n\n`;
  }
  
  if (tipo === 'completo' || tipo === 'limpiezas') {
    const serviciosMes = S.servicios.filter(s => (s.fecha_servicio || '').slice(0, 7) === mes);
    csv += 'LIMPIEZAS\n';
    csv += 'Fecha,Propiedad,Tipo,Estado\n';
    serviciosMes.forEach(s => {
      const p = S.propiedades.find(pr => pr.id === s.propiedad_id);
      csv += `${s.fecha_servicio},"${p?.nombre || ''}",${s.tipo || 'normal'},${s.estado}\n`;
    });
    csv += '\n';
  }
  
  if (tipo === 'propietarios') {
    csv += 'RESUMEN POR PROPIETARIO\n';
    csv += 'Propietario,Propiedades,Limpiezas (â‚¬),Consumos (â‚¬),Total (â‚¬)\n';
    S.propietarios.forEach(prop => {
      const props = S.propiedades.filter(p => p.propietario_id === prop.id);
      // Simplified calculation
      csv += `"${prop.nombre}",${props.length},0,0,0\n`;
    });
  }
  
  const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
  const link = document.createElement('a');
  link.href = URL.createObjectURL(blob);
  link.download = `cleanmanager_${mes}.csv`;
  link.click();
  
  toast('ğŸ“— Excel descargado', 'success');
}

function exportPDFMensual() {
  $('#informe-mes').value = currentConsumosMes;
  $('#informe-tipo').value = 'mensual';
  generarInformePDF();
}

function exportExcelCompleto() {
  $('#excel-mes').value = currentConsumosMes;
  $('#excel-tipo').value = 'completo';
  exportarExcel();
}

function openInformePropietario() {
  $('#informe-tipo').value = 'propietario';
  document.getElementById('informe-propietario-select').style.display = 'block';
  $('#informe-propietario').innerHTML = S.propietarios.map(p => `<option value="${p.id}">${p.nombre}</option>`).join('');
  navigate('informes');
}

// Toggle propietario select visibility
document.getElementById('informe-tipo')?.addEventListener('change', function() {
  document.getElementById('informe-propietario-select').style.display = this.value === 'propietario' ? 'block' : 'none';
});

// ===============================================
// ALERTAS WHATSAPP
// ===============================================
function loadAlertConfig() {
  const config = JSON.parse(localStorage.getItem('cleanmanager_alerts') || '{}');
  if (config.whatsapp) $('#alert-whatsapp').value = config.whatsapp;
  if (config.email) $('#alert-email').value = config.email;
  if (config.stockBajo !== undefined) $('#alert-stock').checked = config.stockBajo;
  if (config.rotura !== undefined) $('#alert-rotura').checked = config.rotura;
  if (config.diasRotura) $('#alert-dias-rotura').value = config.diasRotura;
  if (config.semanal !== undefined) $('#alert-semanal').checked = config.semanal;
  
  updateAlertPreview();
  renderAlertasEstado();
}

function saveAlertConfig() {
  const config = {
    whatsapp: $('#alert-whatsapp').value,
    email: $('#alert-email').value,
    stockBajo: $('#alert-stock').checked,
    rotura: $('#alert-rotura').checked,
    diasRotura: $('#alert-dias-rotura').value,
    semanal: $('#alert-semanal').checked
  };
  localStorage.setItem('cleanmanager_alerts', JSON.stringify(config));
  toast('âœ… ConfiguraciÃ³n guardada', 'success');
}

function getAlertasActivas() {
  const diasAlerta = parseInt($('#alert-dias-rotura')?.value || 7);
  const fechaLimite = new Date();
  fechaLimite.setDate(fechaLimite.getDate() + diasAlerta);
  
  const criticos = [], bajos = [];
  
  for (const item of S.stock) {
    const forecast = stockForecasts.get(item.id);
    if (forecast?.fechaRotura && new Date(forecast.fechaRotura) <= fechaLimite) {
      criticos.push({ item: item.item, stock: item.stock, fechaRotura: formatDate(forecast.fechaRotura) });
    } else if (item.stock < item.stock_minimo) {
      bajos.push({ item: item.item, stock: item.stock, min: item.stock_minimo });
    }
  }
  
  return { criticos, bajos, length: criticos.length + bajos.length };
}

function updateAlertPreview() {
  const preview = $('#alert-preview');
  if (!preview) return;
  
  const alertas = getAlertasActivas();
  
  if (alertas.length === 0) {
    preview.textContent = 'âœ… *Todo en orden!*\n\nNo hay alertas de stock en este momento.';
    return;
  }
  
  let msg = 'âš ï¸ *ALERTA DE STOCK*\n\n';
  
  if (alertas.criticos.length > 0) {
    msg += 'ğŸš¨ *CRÃTICO - Se agotarÃ¡ pronto:*\n';
    alertas.criticos.forEach(a => {
      msg += `â€¢ ${a.item}: ${a.stock} uds (se agota ${a.fechaRotura})\n`;
    });
    msg += '\n';
  }
  
  if (alertas.bajos.length > 0) {
    msg += 'âš ï¸ *Stock bajo mÃ­nimo:*\n';
    alertas.bajos.forEach(a => {
      msg += `â€¢ ${a.item}: ${a.stock}/${a.min} uds\n`;
    });
  }
  
  preview.textContent = msg;
}

function renderAlertasEstado() {
  const container = $('#alertas-estado-actual');
  if (!container) return;
  
  const alertas = getAlertasActivas();
  
  if (alertas.length === 0) {
    container.innerHTML = '<div class="alert-status success">âœ… Todo el inventario estÃ¡ en orden</div>';
    return;
  }
  
  let html = '';
  if (alertas.criticos.length > 0) {
    html += `<div class="alert-status error">ğŸš¨ ${alertas.criticos.length} artÃ­culo(s) se agotarÃ¡n pronto</div>`;
  }
  if (alertas.bajos.length > 0) {
    html += `<div class="alert-status" style="background:var(--warning-bg);color:var(--warning);">âš ï¸ ${alertas.bajos.length} artÃ­culo(s) bajo mÃ­nimo</div>`;
  }
  container.innerHTML = html;
}

async function testWhatsApp() {
  const phone = $('#alert-whatsapp').value.replace(/\D/g, '');
  if (!phone || phone.length < 10) {
    toast('Introduce un nÃºmero vÃ¡lido', 'error');
    return;
  }
  
  toast('Enviando mensaje de prueba...');
  
  try {
    const response = await fetch('https://n8n.adrianmartinbernabe.com/webhook/builderbot/enviar', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        telefono: phone,
        mensaje: 'âœ… *Prueba de Alertas CleanManager*\n\nEste es un mensaje de prueba del sistema de alertas.\n\nÂ¡ConfiguraciÃ³n correcta!'
      })
    });
    
    if (response.ok) {
      $('#whatsapp-status').innerHTML = '<div class="alert-status success">âœ… Mensaje enviado correctamente</div>';
      toast('âœ… Mensaje enviado', 'success');
    } else {
      throw new Error('Error en respuesta');
    }
  } catch (e) {
    console.error(e);
    $('#whatsapp-status').innerHTML = '<div class="alert-status error">âŒ Error al enviar mensaje</div>';
    toast('Error al enviar', 'error');
  }
}

async function sendAlertaNow() {
  const phone = $('#alert-whatsapp').value.replace(/\D/g, '');
  if (!phone || phone.length < 10) {
    toast('Configura el nÃºmero primero', 'error');
    return;
  }
  
  const alertas = getAlertasActivas();
  if (alertas.length === 0) {
    toast('No hay alertas que enviar', 'success');
    return;
  }
  
  const mensaje = $('#alert-preview').textContent;
  toast('Enviando alerta...');
  
  try {
    await fetch('https://n8n.adrianmartinbernabe.com/webhook/builderbot/enviar', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ telefono: phone, mensaje })
    });
    toast('âœ… Alerta enviada', 'success');
  } catch (e) {
    console.error(e);
    toast('Error al enviar', 'error');
  }
}

// ===============================================
// INICIALIZACIÃ“N EXTRA
// ===============================================
const originalInit = window.initApp;
window.initApp = async function() {
  if (originalInit) await originalInit();
  
  // Init nuevas vistas
  setTimeout(() => {
    calculateForecasts();
    loadAlertConfig();
    
    // Set default month inputs
    const currentMonth = new Date().toISOString().slice(0, 7);
    if ($('#informe-mes')) $('#informe-mes').value = currentMonth;
    if ($('#excel-mes')) $('#excel-mes').value = currentMonth;
  }, 1000);
};

// Override navigate to handle new views
const originalNavigate = window.navigate;
window.navigate = function(view) {
  originalNavigate(view);
  
  if (view === 'limpiezas') {
    renderLimpiezasMes();
  } else if (view === 'consumos') {
    renderConsumos();
  } else if (view === 'informes') {
    // Informes ready
  } else if (view === 'alertas') {
    calculateForecasts();
    updateAlertPreview();
    renderAlertasEstado();
  } else if (view === 'stock') {
    calculateForecasts();
  }
};
</script>
</body>
</html>
